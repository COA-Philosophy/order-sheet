<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オーダーメイドスーツ　オーダーシート</title>
    
    <style>
/* =====================================
   CRMオーダーシート 改善版CSS
   ===================================== */

/* ベースリセット */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
    margin: 20px;
    background-color: #f5f5f5;
    line-height: 1.6;
    color: #333;
}

/* メインコンテナ */
.container {
    max-width: 210mm;
    margin: 0 auto;
    background: white;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    border-radius: 8px;
}

/* ヘッダー */
.header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 3px solid #2c3e50;
    padding-bottom: 15px;
}

.header h1 {
    color: #2c3e50;
    font-size: 28px;
    margin: 0;
    letter-spacing: 2px;
}

.header p {
    color: #7f8c8d;
    margin: 5px 0 0 0;
    font-size: 14px;
}

/* セクション共通 */
.section {
    margin-bottom: 25px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
}

.section-title {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
    padding: 12px 15px;
    margin: 0;
    font-size: 16px;
    font-weight: bold;
}

.section-content {
    padding: 20px;
}

/* フォーム要素 */
.form-row {
    display: flex;
    margin-bottom: 15px;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.form-group {
    flex: 1;
    min-width: 200px;
    margin-bottom: 15px;
}

.form-group:last-child {
    margin-right: 0;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #2c3e50;
    font-size: 14px;
}

.required {
    color: #e74c3c;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

/* 必須情報セクション専用スタイル */
.essential-info {
    border: 3px solid #e74c3c;
    background: linear-gradient(135deg, #fff5f5, #ffffff);
    box-shadow: 0 8px 25px rgba(231, 76, 60, 0.15);
}

.essential-info .section-title {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    font-size: 18px;
    padding: 15px 20px;
}

.input-guide {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    color: #495057;
}

.input-guide p {
    margin: 0;
    font-size: 14px;
}

/* 必須項目グループ */
.essential-group {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.essential-group:hover {
    border-color: #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
}

.essential-group.completed {
    border-color: #27ae60;
    background: linear-gradient(135deg, #f8fff8, #ffffff);
}

.essential-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.step-number {
    background: #3498db;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
    font-size: 14px;
}

.essential-header h4 {
    flex: 1;
    margin: 0;
    color: #2c3e50;
    font-size: 16px;
}

.check-mark {
    background: #27ae60;
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    opacity: 0;
    transition: all 0.3s ease;
}

.check-mark.visible {
    opacity: 1;
    transform: scale(1.1);
}

/* 大きな入力フィールド */
.large-input input, .large-input select {
    font-size: 16px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.large-input input:focus, .large-input select:focus {
    border-color: #3498db;
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
    transform: translateY(-2px);
}

.large-input input.valid {
    border-color: #27ae60;
    background: linear-gradient(135deg, #f8fff8, #ffffff);
}

.large-input input.invalid {
    border-color: #e74c3c;
    background: linear-gradient(135deg, #fff5f5, #ffffff);
}

/* 名前入力エリア（統合版） */
.name-input {
    margin-bottom: 15px;
}

/* 生年月日入力エリア */
.birth-date-inputs {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 15px;
}

/* 住所入力エリア */
.address-inputs .postal-row {
    display: flex;
    gap: 10px;
    align-items: end;
    margin-bottom: 15px;
}

.address-lookup-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 15px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.address-lookup-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

/* 入力ヒント */
.input-hint {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 5px;
    font-style: italic;
}

.postal-hint {
    color: #27ae60;
    font-size: 12px;
    margin-left: 10px;
}

/* 進捗バー */
.progress-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    text-align: center;
}

.progress-bar {
    background: #e9ecef;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    height: 100%;
    width: 0%;
    transition: width 0.5s ease;
    border-radius: 4px;
}

.progress-text {
    font-weight: bold;
    color: #2c3e50;
    font-size: 14px;
}

/* 完了ステータス */
.essential-group.completed .step-number {
    background: #27ae60;
}

/* 採寸グリッド */
.measurement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

/* チェックボックスグループ */
.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    min-width: 150px;
}

.checkbox-item input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
}

/* スタイルアイテム */
.style-item {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #fafafa;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.style-item:hover {
    border-color: #3498db;
    background: #f8f9fa;
}

.style-item.removing {
    animation: fadeOut 0.3s ease-out forwards;
}

@keyframes fadeOut {
    from {
        opacity: 1;
        max-height: 1000px;
        margin-bottom: 20px;
    }
    to {
        opacity: 0;
        max-height: 0;
        margin-bottom: 0;
        padding: 0;
    }
}

.style-item.adding {
    animation: fadeIn 0.3s ease-out forwards;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        max-height: 0;
        margin-bottom: 0;
        padding: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
        margin-bottom: 20px;
        padding: 20px;
    }
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e0e0e0;
}

.item-header h5 {
    color: #2c3e50;
    margin: 0;
    font-size: 16px;
    font-weight: bold;
}

.item-count {
    background: #3498db;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    border-radius: 6px;
    margin-bottom: 20px;
}

/* 総計セクション */
.total-section {
    background: #f8f9fa;
    border: 2px solid #3498db;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 16px;
}

.total-row.grand-total {
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
    border-top: 2px solid #3498db;
    padding-top: 10px;
    margin-top: 15px;
}

/* 備考エリア（拡大版） */
.notes-area {
    height: 150px;
}

/* ボタン */
.download-btn {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 16px;
    cursor: pointer;
    display: block;
    margin: 10px auto;
    transition: all 0.3s ease;
    min-width: 200px;
}

.download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.save-btn {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
}

.save-btn:hover {
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
}

.add-item-btn {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.add-item-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
}

.remove-item-btn {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.remove-item-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(231, 76, 60, 0.4);
}

/* ステータスメッセージ */
.status-message {
    padding: 15px;
    border-radius: 6px;
    margin: 20px 0;
    text-align: center;
    font-weight: bold;
}

.status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

/* セレクトボックスのオプショングループスタイル */
optgroup {
    font-weight: bold;
    font-style: normal;
    color: #2c3e50;
    background-color: #f8f9fa;
}

optgroup option {
    font-weight: normal;
    color: #333;
    background-color: white;
    padding-left: 20px;
}

/* アニメーション */
@keyframes checkmark {
    0% {
        opacity: 0;
        transform: scale(0.5);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.check-mark.visible {
    animation: checkmark 0.5s ease;
}

/* フォーカス時のハイライト */
.form-group.focused {
    background: #f0f8ff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
    transition: all 0.3s ease;
}

/* モバイル用次へボタン */
.mobile-next-btn {
    display: none;
    width: 100%;
    margin-top: 15px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

@media (max-width: 768px) {
    .mobile-next-btn {
        display: block;
    }
}

.mobile-next-btn:active {
    transform: scale(0.98);
    box-shadow: 0 2px 10px rgba(52, 152, 219, 0.4);
}

/* モバイルでのinput要素の改善 */
@media (max-width: 768px) {
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 16px; /* iOS Safari のズーム防止 */
        padding: 12px;
    }
    
    .large-input input,
    .large-input select {
        font-size: 18px;
        padding: 15px;
    }
    
    /* タップターゲットを大きく */
    .checkbox-item {
        padding: 10px 0;
    }
    
    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
    }
}

/* モバイル対応 */
@media (max-width: 768px) {
    body {
        margin: 10px;
    }
    
    .container {
        padding: 15px;
    }
    
    .header h1 {
        font-size: 22px;
    }
    
    .form-row {
        flex-direction: column;
        gap: 0;
    }
    
    .form-group {
        margin-right: 0;
        margin-bottom: 15px;
        min-width: auto;
    }
    
    .measurement-grid {
        grid-template-columns: 1fr;
    }
    
    .checkbox-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .checkbox-item {
        min-width: auto;
    }
    
    .birth-date-inputs {
        grid-template-columns: 1fr;
    }
    
    .address-inputs .postal-row {
        flex-direction: column;
        gap: 15px;
    }
    
    .essential-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .step-number {
        align-self: flex-start;
    }
    
    .download-btn {
        min-width: auto;
        width: 100%;
    }
}

/* 印刷対応 - モバイル対応改良版 */
@media print {
    /* A4サイズ設定 */
    @page {
        size: A4;
        margin: 10mm;
    }
    
    body { 
        margin: 0; 
        background: white;
        font-size: 8pt !important;
        line-height: 1.3 !important;
    }
    
    .container { 
        box-shadow: none; 
        margin: 0; 
        max-width: none;
        padding: 0;
        width: 100%;
        border-radius: 0;
    }
    
    /* ヘッダー */
    .header {
        margin-bottom: 5px !important;
        padding-bottom: 3px !important;
        border-bottom: 1px solid #2c3e50;
        page-break-after: avoid !important;
    }
    
    .header h1 {
        font-size: 14pt !important;
        margin: 0 !important;
        color: #2c3e50 !important;
    }
    
    .header p {
        font-size: 8pt !important;
        margin: 1px 0 !important;
    }
    
    /* セクション共通 */
    .section {
        margin-bottom: 5px !important;
        page-break-inside: avoid !important;
        border: 0.5px solid #999 !important;
        border-radius: 0 !important;
    }
    
    .section-title {
        font-size: 9pt !important;
        padding: 3px 8px !important;
        background: #f0f0f0 !important;
        color: #333 !important;
        margin: 0 !important;
        border-bottom: 0.5px solid #999 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .section-content {
        padding: 5px !important;
    }
    
    /* 必須情報セクション - 1ページ目上部に配置 */
    .essential-info {
        border: 1px solid #333 !important;
        margin-bottom: 5px !important;
    }
    
    .essential-info .section-title {
        background: #333 !important;
        color: white !important;
        font-size: 10pt !important;
    }
    
    .essential-group {
        display: inline-block !important;
        width: 48% !important;
        vertical-align: top !important;
        border: 0.5px solid #ccc !important;
        padding: 4px !important;
        margin: 0 1% 4px 0 !important;
        background: white !important;
        box-sizing: border-box !important;
    }
    
    .essential-group:nth-child(even) {
        margin-right: 0 !important;
    }
    
    .essential-header {
        display: none !important;
    }
    
    /* 名前をコンパクトに */
    .name-input {
        margin-bottom: 3px !important;
    }
    
    /* 生年月日を1行に */
    .birth-date-inputs {
        display: flex !important;
        gap: 2px !important;
    }
    
    .birth-date-inputs .form-group {
        flex: 1 !important;
    }
    
    /* 住所を超コンパクトに */
    .address-inputs .form-group {
        margin-bottom: 2px !important;
    }
    
    .postal-row {
        margin-bottom: 2px !important;
    }
    
    /* フォーム要素を超コンパクトに */
    .form-row {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 5px !important;
        margin-bottom: 3px !important;
    }
    
    .form-group {
        margin-bottom: 3px !important;
        flex: 1 !important;
        min-width: 60px !important;
    }
    
    .form-group label {
        font-size: 7pt !important;
        margin-bottom: 1px !important;
        font-weight: normal !important;
        color: #333 !important;
        line-height: 1 !important;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        border: none !important;
        border-bottom: 0.5px solid #999 !important;
        padding: 1px !important;
        font-size: 8pt !important;
        background: none !important;
        font-weight: normal !important;
        color: #000 !important;
        height: 12px !important;
        line-height: 1 !important;
    }
    
    /* 入力済みフィールド */
    input:not(:placeholder-shown),
    select:not([value=""]):not([value=""]),
    textarea:not(:placeholder-shown) {
        font-weight: bold !important;
        border-bottom: 0.5px solid #000 !important;
    }
    
    /* 採寸グリッドを超高密度に */
    .measurement-grid {
        display: grid !important;
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 3px !important;
        font-size: 7pt !important;
    }
    
    .measurement-grid .form-group {
        min-width: 40px !important;
    }
    
    /* セクションタイトルを非表示 */
    h4 {
        display: none !important;
    }
    
    /* =================================
       スタイルアイテムの横並び改善
       ================================= */
    .style-item {
        border: 0.5px solid #666 !important;
        padding: 3px !important;
        margin-bottom: 4px !important;
        background: white !important;
        page-break-inside: avoid !important;
    }
    
    /* アイテムヘッダーをよりコンパクトに */
    .style-item .item-header {
        margin-bottom: 2px !important;
        padding-bottom: 1px !important;
        border-bottom: 0.5px solid #ccc !important;
    }
    
    .style-item .item-header h5 {
        font-size: 8pt !important;
        margin: 0 !important;
        font-weight: bold !important;
    }
    
    /* フォーム行を4列グリッドに変更 */
    .style-item .form-row {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 3px !important;
        margin-bottom: 2px !important;
    }
    
    /* フォームグループの最適化 */
    .style-item .form-group {
        margin-bottom: 0 !important;
        min-width: auto !important;
    }
    
    /* ラベルを超短縮表示 */
    .style-item .form-group label {
        font-size: 5pt !important;
        margin-bottom: 0 !important;
        line-height: 1 !important;
        font-weight: bold !important;
        color: #000 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
    }
    
    /* 特定のラベルを短縮 */
    .style-item label[for*="itemType_"] { display: none !important; }
    .style-item label[for*="itemType_"]::after { 
        content: "タイプ" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="fabric_"] { display: none !important; }
    .style-item label[for*="fabric_"]::after { 
        content: "生地" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="color_"] { display: none !important; }
    .style-item label[for*="color_"]::after { 
        content: "色" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="jacketStyle_"] { display: none !important; }
    .style-item label[for*="jacketStyle_"]::after { 
        content: "Jスタイル" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="lining_"] { display: none !important; }
    .style-item label[for*="lining_"]::after { 
        content: "裏地" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="buttons_"] { display: none !important; }
    .style-item label[for*="buttons_"]::after { 
        content: "ボタン" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="chestPocket_"] { display: none !important; }
    .style-item label[for*="chestPocket_"]::after { 
        content: "胸P" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="waistPocket_"] { display: none !important; }
    .style-item label[for*="waistPocket_"]::after { 
        content: "腰P" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="lapelStyle_"] { display: none !important; }
    .style-item label[for*="lapelStyle_"]::after { 
        content: "衿型" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="price_"] { display: none !important; }
    .style-item label[for*="price_"]::after { 
        content: "価格" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="deliveryDate_"] { display: none !important; }
    .style-item label[for*="deliveryDate_"]::after { 
        content: "納期" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    .style-item label[for*="notes_"] { display: none !important; }
    .style-item label[for*="notes_"]::after { 
        content: "備考" !important; 
        display: block !important;
        font-size: 5pt !important;
    }
    
    /* 入力フィールドも超コンパクトに */
    .style-item input,
    .style-item select,
    .style-item textarea {
        font-size: 6pt !important;
        height: 10px !important;
        padding: 0 1px !important;
        line-height: 1 !important;
        border-bottom: 0.5px solid #999 !important;
    }
    
    /* 価格と納期を同じ行に */
    .style-item .form-row:last-of-type {
        grid-template-columns: 1fr 1fr !important;
    }
    
    /* 備考欄を横幅いっぱいに */
    .style-item .form-group:has(textarea) {
        grid-column: 1 / -1 !important;
    }
    
    .style-item textarea {
        height: 15px !important;
        font-size: 6pt !important;
    }
    
    /* チェックボックスを最小化 */
    .checkbox-group {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 2px !important;
        font-size: 6pt !important;
        margin-top: 2px !important;
    }
    
    .checkbox-item {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
    
    .checkbox-item input[type="checkbox"] {
        width: 6px !important;
        height: 6px !important;
        margin-right: 1px !important;
    }
    
    /* オプションラベルも短縮 */
    .style-item .checkbox-group > div[style*="width: 100%"] {
        display: none !important;
    }
    
    /* アイテム間の余白を最小化 */
    .style-item + .style-item {
        margin-top: 3px !important;
    }
    
    /* 価格セクションを超コンパクトに */
    .total-section {
        border: 0.5px solid #000 !important;
        padding: 3px !important;
        margin-top: 4px !important;
        background: #f9f9f9 !important;
        page-break-inside: avoid !important;
    }
    
    .total-section h4 {
        display: none !important;
    }
    
    #priceBreakdown {
        font-size: 7pt !important;
        margin-bottom: 2px !important;
    }
    
    .total-row {
        font-size: 8pt !important;
        margin-bottom: 2px !important;
    }
    
    .total-row.grand-total {
        font-size: 10pt !important;
        font-weight: bold !important;
        border-top: 0.5px solid #000 !important;
        padding-top: 2px !important;
        margin-top: 3px !important;
    }
    
    /* ディスカウント部分を印刷用に最適化 */
    .total-section > div[style*="background: #fff3cd"] {
        background: none !important;
        border: none !important;
        padding: 2px 0 !important;
        margin-top: 3px !important;
    }
    
    /* 割引入力欄は非表示にして、割引情報のみ表示 */
    .total-section > div[style*="background: #fff3cd"] > div:first-child {
        display: none !important; /* 入力欄の行を非表示 */
    }
    
    /* 割引額表示は維持 */
    .total-section > div[style*="background: #fff3cd"] > div:last-child {
        margin-top: 0 !important;
        text-align: left !important;
        font-size: 8pt !important;
        font-weight: normal !important;
    }
    
    /* 割引額の表示を調整 */
    #discountDisplay {
        font-weight: bold !important;
        color: #000 !important;
    }
    
    /* 最終価格と内金・残金 */
    #payment-section .form-row {
        gap: 3px !important;
    }
    
    #payment-section .form-group {
        min-width: 50px !important;
    }
    
    /* 備考欄を拡大（サイン欄削除分） */
    .notes-area {
        height: 60px !important;
        font-size: 8pt !important;
    }
    
    /* 非表示要素 */
    .download-btn,
    .print-preview-btn,
    .add-item-btn,
    .remove-item-btn,
    .status-message,
    .progress-section,
    .save-section,
    .mobile-next-btn,
    .address-lookup-btn,
    .input-hint,
    .input-guide,
    .step-number,
    .check-mark,
    .save-btn,
    .item-count,
    .postal-hint {
        display: none !important;
    }
    
    /* textareaの高さ制限 */
    textarea {
        resize: none !important;
        overflow: hidden !important;
    }
    
    /* ページ分割戦略 */
    /* 1-2アイテム: すべて1ページに収める */
    /* 3個以上: 基本情報1ページ + アイテム情報を別ページ */
    
    /* アイテムが3個以上の場合、スタイルセクションを新しいページに */
    .style-section-3plus {
        page-break-before: always !important;
    }
    
    /* 各セクション間の余白を最小化 */
    * {
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* 必要な要素のみ最小限のパディングを追加 */
    .section-content,
    .form-group,
    .style-item,
    .essential-group {
        padding: 3px !important;
    }
    
    /* 空白行の削除 */
    br {
        display: none !important;
    }
    
    /* モバイル印刷の最適化 */
    @media (max-width: 768px) {
        body {
            font-size: 7pt !important;
        }
        
        .header h1 {
            font-size: 12pt !important;
        }
        
        .section-title {
            font-size: 8pt !important;
        }
        
        .form-group label {
            font-size: 6pt !important;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            font-size: 7pt !important;
        }
        
        .measurement-grid {
            grid-template-columns: repeat(4, 1fr) !important;
        }
        
        .checkbox-group {
            grid-template-columns: repeat(2, 1fr) !important;
            font-size: 5pt !important;
        }
    }
}

/* フォーカス強化 */
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-width: 3px;
}

/* 無効状態 */
.form-group input:disabled,
.form-group select:disabled,
.form-group textarea:disabled {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

/* プレースホルダー */
.form-group input::placeholder,
.form-group textarea::placeholder {
    color: #adb5bd;
    font-style: italic;
}

/* スクロールバー（Webkit系ブラウザ） */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* セレクトボックスの見た目向上 */
select {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}

/* 保存セクション */
.save-section {
    margin-top: 30px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
}

.save-section h3 {
    margin-bottom: 20px;
}

/* 印刷プレビューモード */
.print-preview-mode {
    background: white !important;
}

.print-preview-mode .container {
    max-width: 210mm !important;
    box-shadow: 0 0 20px rgba(0,0,0,0.3) !important;
}

/* モーダルスタイル（モーダルダイアログ用） */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal-overlay[style*="display: block"] {
    display: flex !important;
}

.modal-content {
    background: white;
    padding: 0;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    position: relative;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
}

.modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
    opacity: 0.8;
    transition: opacity 0.3s;
}

.modal-close:hover {
    opacity: 1;
}

.modal-body {
    padding: 20px;
}

.filename-display {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    font-family: monospace;
    font-size: 14px;
    color: #495057;
    cursor: pointer;
    user-select: all;
    transition: all 0.3s;
}

.filename-display:hover {
    border-color: #3498db;
    background: #e3f2fd;
}

.copy-button {
    width: 100%;
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.copy-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
}

.copy-button.copied {
    background: linear-gradient(135deg, #27ae60, #219a52);
}

.modal-instructions {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.modal-instructions h4 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

.modal-instructions ol {
    margin: 0;
    padding-left: 20px;
    color: #495057;
    line-height: 1.8;
}

.modal-footer {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modal-button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-button.primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.modal-button.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
}

.modal-button.secondary {
    background: #e9ecef;
    color: #495057;
}

.modal-button.secondary:hover {
    background: #dee2e6;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>オーダーメイドスーツ オーダーシート</h1>
            <p>Order Date: <span id="currentDate"></span> | Order No: <span id="orderNumber"></span></p>
        </div>

        <!-- ステータスメッセージエリア -->
        <div id="statusMessage" style="display: none;"></div>

        <!-- 必須情報セクション（顧客入力用） -->
        <div class="section essential-info">
            <h2 class="section-title">✨ 必須情報の入力（お客様ご記入ください）</h2>
            <div class="section-content">
                <div class="input-guide">
                    <p>📝 以下の4項目のご入力をお願いいたします。入力完了でチェックマークが表示されます。</p>
                </div>
                
                <!-- お名前（統合版） -->
                <div class="essential-group">
                    <div class="essential-header">
                        <span class="step-number">1</span>
                        <h4>お名前</h4>
                        <span class="check-mark" id="nameCheck">✓</span>
                    </div>
                    <div class="name-input">
                        <div class="form-group large-input">
                            <label for="fullName">お名前</label>
                            <input type="text" id="fullName" name="fullName" placeholder="山田 太郎" required autocomplete="name" enterkeyhint="next">
                        </div>
                        <div class="form-group">
                            <label for="fullNameKana">フリガナ</label>
                            <input type="text" id="fullNameKana" name="fullNameKana" placeholder="ヤマダ タロウ" autocomplete="name" enterkeyhint="next">
                        </div>
                    </div>
                </div>

                <!-- 電話番号 -->
                <div class="essential-group">
                    <div class="essential-header">
                        <span class="step-number">2</span>
                        <h4>電話番号</h4>
                        <span class="check-mark" id="phoneCheck">✓</span>
                    </div>
                    <div class="form-group large-input">
                        <label for="phone">携帯電話または固定電話</label>
                        <input type="tel" id="phone" name="phone" placeholder="090-1234-5678" required autocomplete="tel" enterkeyhint="next" inputmode="tel">
                        <div class="input-hint">ハイフン（-）ありでも、なしでもOKです</div>
                    </div>
                </div>

                <!-- 生年月日 -->
                <div class="essential-group">
                    <div class="essential-header">
                        <span class="step-number">3</span>
                        <h4>生年月日</h4>
                        <span class="check-mark" id="birthCheck">✓</span>
                    </div>
                    <div class="birth-date-inputs">
                        <div class="form-group">
                            <label for="birthYear">年</label>
                            <select id="birthYear" name="birthYear" required>
                                <option value="">----</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="birthMonth">月</label>
                            <select id="birthMonth" name="birthMonth" required>
                                <option value="">--</option>
                                <option value="1">1月</option>
                                <option value="2">2月</option>
                                <option value="3">3月</option>
                                <option value="4">4月</option>
                                <option value="5">5月</option>
                                <option value="6">6月</option>
                                <option value="7">7月</option>
                                <option value="8">8月</option>
                                <option value="9">9月</option>
                                <option value="10">10月</option>
                                <option value="11">11月</option>
                                <option value="12">12月</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="birthDay">日</label>
                            <select id="birthDay" name="birthDay" required>
                                <option value="">--</option>
                            </select>
                        </div>
                        <input type="hidden" id="birthDate" name="birthDate">
                    </div>
                </div>

                <!-- 住所 -->
                <div class="essential-group">
                    <div class="essential-header">
                        <span class="step-number">4</span>
                        <h4>ご住所</h4>
                        <span class="check-mark" id="addressCheck">✓</span>
                    </div>
                    <div class="address-inputs">
                        <div class="postal-row">
                            <div class="form-group">
                                <label for="postalCode">郵便番号<span class="postal-hint">✅ ハイフンなしでOK</span></label>
                                <input type="text" id="postalCode" name="postalCode" placeholder="1234567" autocomplete="postal-code" enterkeyhint="next" inputmode="numeric">
                            </div>
                            <button type="button" class="address-lookup-btn" onclick="lookupAddress()">住所検索</button>
                        </div>
                        <div class="form-group">
                            <label for="prefecture">都道府県</label>
                            <select id="prefecture" name="prefecture" autocomplete="address-level1">
                                <option value="">選択してください</option>
                                <option value="北海道">北海道</option>
                                <option value="青森県">青森県</option>
                                <option value="岩手県">岩手県</option>
                                <option value="宮城県">宮城県</option>
                                <option value="秋田県">秋田県</option>
                                <option value="山形県">山形県</option>
                                <option value="福島県">福島県</option>
                                <option value="茨城県">茨城県</option>
                                <option value="栃木県">栃木県</option>
                                <option value="群馬県">群馬県</option>
                                <option value="埼玉県">埼玉県</option>
                                <option value="千葉県">千葉県</option>
                                <option value="東京都">東京都</option>
                                <option value="神奈川県">神奈川県</option>
                                <option value="新潟県">新潟県</option>
                                <option value="富山県">富山県</option>
                                <option value="石川県">石川県</option>
                                <option value="福井県">福井県</option>
                                <option value="山梨県">山梨県</option>
                                <option value="長野県">長野県</option>
                                <option value="岐阜県">岐阜県</option>
                                <option value="静岡県">静岡県</option>
                                <option value="愛知県">愛知県</option>
                                <option value="三重県">三重県</option>
                                <option value="滋賀県">滋賀県</option>
                                <option value="京都府">京都府</option>
                                <option value="大阪府">大阪府</option>
                                <option value="兵庫県">兵庫県</option>
                                <option value="奈良県">奈良県</option>
                                <option value="和歌山県">和歌山県</option>
                                <option value="鳥取県">鳥取県</option>
                                <option value="島根県">島根県</option>
                                <option value="岡山県">岡山県</option>
                                <option value="広島県">広島県</option>
                                <option value="山口県">山口県</option>
                                <option value="徳島県">徳島県</option>
                                <option value="香川県">香川県</option>
                                <option value="愛媛県">愛媛県</option>
                                <option value="高知県">高知県</option>
                                <option value="福岡県">福岡県</option>
                                <option value="佐賀県">佐賀県</option>
                                <option value="長崎県">長崎県</option>
                                <option value="熊本県">熊本県</option>
                                <option value="大分県">大分県</option>
                                <option value="宮崎県">宮崎県</option>
                                <option value="鹿児島県">鹿児島県</option>
                                <option value="沖縄県">沖縄県</option>
                            </select>
                        </div>
                        <div class="form-group large-input">
                            <label for="address">市区町村・番地・建物名</label>
                            <input type="text" id="address" name="address" placeholder="渋谷区恵比寿1-2-3 恵比寿ビル101号" required autocomplete="address-line1" enterkeyhint="done">
                        </div>
                    </div>
                </div>

                <!-- 入力進捗 -->
                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">入力完了: <span id="progressText">0/4</span></div>
                </div>
            </div>
        </div>

        <!-- 任意情報セクション -->
        <div class="section">
            <h2 class="section-title">📋 追加情報（任意）</h2>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="referrer">ご紹介者様</label>
                        <input type="text" id="referrer" name="referrer" placeholder="ご紹介いただいた方のお名前">
                    </div>
                    <div class="form-group">
                        <label for="gender">性別（任意）</label>
                        <select id="gender" name="gender">
                            <option value="">選択してください</option>
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="occupation">職業（任意）</label>
                        <input type="text" id="occupation" name="occupation" placeholder="例：会社員、経営者、自営業">
                    </div>
                </div>
            </div>
        </div>

        <!-- 採寸情報セクション -->
        <div class="section">
            <h2 class="section-title">📏 採寸情報</h2>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="height">身長（cm）</label>
                        <input type="number" id="height" name="height" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="weight">体重（kg）</label>
                        <input type="number" id="weight" name="weight" step="0.1">
                    </div>
                </div>
                
                <!-- 基本採寸 -->
                <h4 style="color: #2c3e50; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">基本採寸</h4>
                <div class="measurement-grid">
                    <div class="form-group">
                        <label for="chest">胸囲（cm）</label>
                        <input type="number" id="chest" name="chest" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="waist">ウエスト（cm）</label>
                        <input type="number" id="waist" name="waist" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="hip">ヒップ（cm）</label>
                        <input type="number" id="hip" name="hip" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="shoulderWidth">肩幅（cm）</label>
                        <input type="number" id="shoulderWidth" name="shoulderWidth" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="jacketLength">上着丈（cm）</label>
                        <input type="number" id="jacketLength" name="jacketLength" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="neckSize">首回り（cm）</label>
                        <input type="number" id="neckSize" name="neckSize" step="0.1">
                    </div>
                </div>

                <!-- 袖採寸 -->
                <h4 style="color: #2c3e50; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">袖採寸</h4>
                <div class="measurement-grid">
                    <div class="form-group">
                        <label for="armLengthLeft">袖丈左（cm）</label>
                        <input type="number" id="armLengthLeft" name="armLengthLeft" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="armLengthRight">袖丈右（cm）</label>
                        <input type="number" id="armLengthRight" name="armLengthRight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="yokoLength">裄丈（cm）</label>
                        <input type="number" id="yokoLength" name="yokoLength" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="armHole">AH（cm）</label>
                        <input type="number" id="armHole" name="armHole" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="upperArmCircum">二の腕周り（cm）</label>
                        <input type="number" id="upperArmCircum" name="upperArmCircum" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="elbowCircum">肘周り（cm）</label>
                        <input type="number" id="elbowCircum" name="elbowCircum" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="wristCircum">手首周り（cm）</label>
                        <input type="number" id="wristCircum" name="wristCircum" step="0.1">
                    </div>
                </div>

                <!-- ベスト採寸 -->
                <h4 style="color: #2c3e50; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">ベスト採寸</h4>
                <div class="measurement-grid">
                    <div class="form-group">
                        <label for="vestLength">ベスト丈（cm）</label>
                        <input type="number" id="vestLength" name="vestLength" step="0.1">
                    </div>
                </div>

                <!-- パンツ採寸 -->
                <h4 style="color: #2c3e50; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">パンツ採寸</h4>
                <div class="measurement-grid">
                    <div class="form-group">
                        <label for="pantWaist">パンツウエスト（cm）</label>
                        <input type="number" id="pantWaist" name="pantWaist" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="crotchDepth">股上（cm）</label>
                        <input type="number" id="crotchDepth" name="crotchDepth" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="inseam">股下（cm）</label>
                        <input type="number" id="inseam" name="inseam" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="pantTotalLength">パンツ総丈（cm）</label>
                        <input type="number" id="pantTotalLength" name="pantTotalLength" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="inseamActual">パンツ股下実寸（cm）</label>
                        <input type="number" id="inseamActual" name="inseamActual" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="thighCircum">太もも周り（cm）</label>
                        <input type="number" id="thighCircum" name="thighCircum" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="kneeCircum">膝周り（cm）</label>
                        <input type="number" id="kneeCircum" name="kneeCircum" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="calfCircum">ふくらはぎ周り（cm）</label>
                        <input type="number" id="calfCircum" name="calfCircum" step="0.1">
                    </div>
                </div>

                <!-- 詳細採寸 -->
                <h4 style="color: #2c3e50; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e0e0e0;">詳細採寸</h4>
                <div class="measurement-grid">
                    <div class="form-group">
                        <label for="shoulderSlopeLeft">肩傾斜左（度）</label>
                        <input type="number" id="shoulderSlopeLeft" name="shoulderSlopeLeft" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="shoulderSlopeRight">肩傾斜右（度）</label>
                        <input type="number" id="shoulderSlopeRight" name="shoulderSlopeRight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="kamaDepth">鎌深（cm）</label>
                        <input type="number" id="kamaDepth" name="kamaDepth" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="strapLength">ストラップ寸（cm）</label>
                        <input type="number" id="strapLength" name="strapLength" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="overShoulderLength">オーバーショルダー寸（cm）</label>
                        <input type="number" id="overShoulderLength" name="overShoulderLength" step="0.1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bodyType">体型の特徴・注意点</label>
                    <textarea id="bodyType" name="bodyType" rows="3" placeholder="なで肩、いかり肩、左右差など"></textarea>
                </div>
            </div>
        </div>

        <!-- スタイル・仕様セクション -->
        <div class="section">
            <h2 class="section-title">👔 スタイル・仕様</h2>
            <div class="section-content">
                <div class="item-count">
                    オーダーアイテム数: <span id="itemCount">1</span>着
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <h4 style="color: #2c3e50; margin: 0;">オーダーアイテム一覧</h4>
                    <button type="button" class="add-item-btn" onclick="addStyleItem()">+ アイテム追加</button>
                </div>
                
                <div id="styleItemsContainer">
                    <!-- 初期アイテム -->
                    <div class="style-item" data-item="1">
                        <div class="item-header">
                            <h5>アイテム 1</h5>
                            <button type="button" class="remove-item-btn" onclick="removeStyleItem(1)" style="display: none;">削除</button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="itemType_1">アイテムタイプ</label>
                                <select id="itemType_1" name="itemType_1">
                                    <option value="">選択してください</option>
                                    <option value="Suit(2P)">Suit(2P)</option>
                                    <option value="Suit(3P)">Suit(3P)</option>
                                    <option value="Suit+Pants">Suit+Pants</option>
                                    <option value="Suit(3P)+Pants">Suit(3P)+Pants</option>
                                    <option value="Jacket(S)">Jacket(S)</option>
                                    <option value="Jacket(D)">Jacket(D)</option>
                                    <option value="Vest">Vest</option>
                                    <option value="Pants">Pants</option>
                                    <option value="D Suit">D Suit</option>
                                    <option value="D Suit(3P)">D Suit(3P)</option>
                                    <option value="D Suit+Pants">D Suit+Pants</option>
                                    <option value="D Suit(3P)+Pants">D Suit(3P)+Pants</option>
                                    <option value="Shirts">Shirts</option>
                                    <option value="Tie">Tie</option>
                                    <option value="Repair">Repair</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fabric_1">生地</label>
                                <input type="text" id="fabric_1" name="fabric_1" placeholder="生地番号・名称">
                            </div>
                            <div class="form-group">
                                <label for="color_1">色</label>
                                <input type="text" id="color_1" name="color_1">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jacketStyle_1">ジャケットスタイル</label>
                                <select id="jacketStyle_1" name="jacketStyle_1">
                                    <option value="">選択してください</option>
                                    <optgroup label="シングル">
                                        <option value="single_2x1">シングル２×１</option>
                                        <option value="single_1x1">シングル１×１</option>
                                        <option value="single_3x1">シングル３×１</option>
                                    </optgroup>
                                    <optgroup label="ダブル">
                                        <option value="double_6x2">ダブル６×２</option>
                                        <option value="double_4x2">ダブル４×２</option>
                                        <option value="double_2x1">ダブル２×１</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="liningType_1">裏地仕様</label>
                                <select id="liningType_1" name="liningType_1">
                                    <option value="">選択してください</option>
                                    <option value="senuki">背抜き</option>
                                    <option value="soura">総裏</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lining_1">裏地</label>
                                <input type="text" id="lining_1" name="lining_1" placeholder="裏地の種類・色">
                            </div>
                            <div class="form-group">
                                <label for="buttons_1">ボタン</label>
                                <input type="text" id="buttons_1" name="buttons_1" placeholder="ボタンの種類・材質">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jacketFit_1">ジャケットフィット</label>
                                <select id="jacketFit_1" name="jacketFit_1">
                                    <option value="">選択してください</option>
                                    <option value="tight">タイトフィット</option>
                                    <option value="basic">ベーシックフィット</option>
                                    <option value="loose">ルーズフィット</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pantsFit_1">パンツフィット</label>
                                <select id="pantsFit_1" name="pantsFit_1">
                                    <option value="">選択してください</option>
                                    <option value="tight">タイトフィット</option>
                                    <option value="basic">ベーシックフィット</option>
                                    <option value="loose">ルーズフィット</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pantsShape_1">パンツ形状</label>
                                <select id="pantsShape_1" name="pantsShape_1">
                                    <option value="">選択してください</option>
                                    <option value="tapered">テーパード</option>
                                    <option value="straight">ストレート</option>
                                    <option value="wide">ワイド</option>
                                    <option value="slight_flare">少しフレア</option>
                                    <option value="flare">フレア</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="chestPocket_1">胸ポケット</label>
                                <select id="chestPocket_1" name="chestPocket_1">
                                    <option value="">選択してください</option>
                                    <option value="barca">バルカポケット</option>
                                    <option value="box">箱ポケット</option>
                                    <option value="out">アウトポケット</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="waistPocket_1">腰ポケット</label>
                                <select id="waistPocket_1" name="waistPocket_1">
                                    <option value="">選択してください</option>
                                    <option value="flap">フラップポケット</option>
                                    <option value="out">アウトポケット</option>
                                    <option value="double_piping">両玉縁ポケット（フラップなし）</option>
                                    <option value="change">チェンジポケット</option>
                                    <option value="hacking">ハッキングポケット</option>
                                    <option value="hacking_change">ハッキングチェンジP</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lapelStyle_1">衿型（ラペル・カラー）</label>
                                <select id="lapelStyle_1" name="lapelStyle_1">
                                    <option value="">選択してください</option>
                                    <optgroup label="ジャケット・スーツ">
                                        <option value="notched">ノッチドラペル（一般的）</option>
                                        <option value="peaked">ピークドラペル（剣先）</option>
                                        <option value="shawl">ショールカラー</option>
                                        <option value="narrow">ナローラペル</option>
                                        <option value="wide">ワイドラペル</option>
                                    </optgroup>
                                    <optgroup label="シャツカラー">
                                        <option value="regular_collar">レギュラーカラー</option>
                                        <option value="semi_wide_collar">セミワイドカラー</option>
                                        <option value="wide_collar">ワイドカラー</option>
                                        <option value="horizontal_wide_collar">ホリゾンタルワイドカラー</option>
                                        <option value="round_collar">ラウンドカラー</option>
                                        <option value="open_collar">オープンカラー</option>
                                        <option value="stand_collar">スタンドカラー</option>
                                        <option value="wing_collar">ウィングカラー</option>
                                        <option value="short_regular_collar">ショートレギュラーカラー</option>
                                        <option value="short_semi_wide_collar">ショートセミワイドカラー</option>
                                        <option value="short_wide_collar">ショートワイドカラー</option>
                                        <option value="short_horizontal_wide_collar">ショートホリゾンタルワイドカラー</option>
                                        <option value="short_round_collar">ショートラウンドカラー</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lapelWidth_1">衿幅</label>
                                <select id="lapelWidth_1" name="lapelWidth_1">
                                    <option value="">選択してください</option>
                                    <option value="5">5cm</option>
                                    <option value="5.5">5.5cm</option>
                                    <option value="6">6cm</option>
                                    <option value="6.5">6.5cm</option>
                                    <option value="7">7cm</option>
                                    <option value="7.5">7.5cm</option>
                                    <option value="8">8cm</option>
                                    <option value="8.5">8.5cm</option>
                                    <option value="9">9cm</option>
                                    <option value="9.5">9.5cm</option>
                                    <option value="10">10cm</option>
                                    <option value="10.5">10.5cm</option>
                                    <option value="11">11cm</option>
                                    <option value="11.5">11.5cm</option>
                                    <option value="12">12cm</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cuffStyle_1">カフス（袖口）</label>
                                <select id="cuffStyle_1" name="cuffStyle_1">
                                    <option value="">選択してください</option>
                                    <optgroup label="ジャケット・スーツ">
                                        <option value="4button">4つボタン本切羽</option>
                                        <option value="3button">3つボタン本切羽</option>
                                        <option value="4button_fake">4つボタン（飾り）</option>
                                        <option value="3button_fake">3つボタン（飾り）</option>
                                        <option value="surgeons">サージャンカフス</option>
                                        <option value="kissing">キッシングボタン</option>
                                    </optgroup>
                                    <optgroup label="シャツカフス">
                                        <option value="regular_no_opening">レギュラー（開きなし）</option>
                                        <option value="small_round">小丸</option>
                                        <option value="round_b">ラウンドB</option>
                                        <option value="round_c">ラウンドC</option>
                                        <option value="cut_corner">角落ち</option>
                                        <option value="corn">コーン</option>
                                        <option value="turn_up">ターンナップ</option>
                                        <option value="double_cuff">ダブル</option>
                                        <option value="arrow">アロー</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>オプション</label>
                            <div class="checkbox-group">
                                <div style="width: 100%; margin-bottom: 10px;">
                                    <strong style="color: #2c3e50;">ジャケットオプション</strong>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="full_stitch_1" name="options_1" data-price="1500" onchange="updateTotalPrice()">
                                    <label for="full_stitch_1">フルステッチ (¥1,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="functional_sleeves_1" name="options_1" data-price="1500" onchange="updateTotalPrice()">
                                    <label for="functional_sleeves_1">本切羽 (¥1,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="buttonhole_color_1" name="options_1" data-price="1500" onchange="updateTotalPrice()">
                                    <label for="buttonhole_color_1">ボタンホール色変え (¥1,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kurumi_button_1" name="options_1" data-price="1500" onchange="updateTotalPrice()">
                                    <label for="kurumi_button_1">クルミ釦 (¥1,500)</label>
                                </div>
                                
                                <div style="width: 100%; margin: 10px 0;">
                                    <strong style="color: #2c3e50;">裏地オプション</strong>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="lining_a_1" name="options_1" data-price="2500" onchange="updateTotalPrice()">
                                    <label for="lining_a_1">有料裏地A (¥2,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="lining_b_1" name="options_1" data-price="5000" onchange="updateTotalPrice()">
                                    <label for="lining_b_1">有料裏地B (¥5,000)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="lining_c_1" name="options_1" data-price="17000" onchange="updateTotalPrice()">
                                    <label for="lining_c_1">有料裏地C (¥17,000)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hiromikaeshi_1" name="options_1" data-price="3500" onchange="updateTotalPrice()">
                                    <label for="hiromikaeshi_1">広見返し (¥3,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="odaiba_1" name="options_1" data-price="2500" onchange="updateTotalPrice()">
                                    <label for="odaiba_1">お台場 (¥2,500)</label>
                                </div>
                                
                                <div style="width: 100%; margin: 10px 0;">
                                    <strong style="color: #2c3e50;">ボタンオプション</strong>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="button_a_1" name="options_1" data-price="1000" onchange="updateTotalPrice()">
                                    <label for="button_a_1">有料ボタンA (¥1,000)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="button_b_1" name="options_1" data-price="2500" onchange="updateTotalPrice()">
                                    <label for="button_b_1">有料ボタンB (¥2,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="button_c_1" name="options_1" data-price="3900" onchange="updateTotalPrice()">
                                    <label for="button_c_1">有料ボタンC (¥3,900)</label>
                                </div>
                                
                                <div style="width: 100%; margin: 10px 0;">
                                    <strong style="color: #2c3e50;">パンツオプション</strong>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="watch_pocket_1" name="options_1" data-price="1500" onchange="updateTotalPrice()">
                                    <label for="watch_pocket_1">ウォッチポケット (¥1,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="full_lining_1" name="options_1" data-price="2500" onchange="updateTotalPrice()">
                                    <label for="full_lining_1">総裏仕様 (¥2,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="side_adjuster_1" name="options_1" data-price="2500" onchange="updateTotalPrice()">
                                    <label for="side_adjuster_1">サイド尾錠 (¥2,500)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="button_fly_1" name="options_1" data-price="1000" onchange="updateTotalPrice()">
                                    <label for="button_fly_1">ボタン仕様 (¥1,000)</label>
                                </div>
                                
                                <div style="width: 100%; margin: 10px 0;">
                                    <strong style="color: #2c3e50;">ベストオプション</strong>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="vest_collar_1" name="options_1" data-price="3000" onchange="updateTotalPrice()">
                                    <label for="vest_collar_1">衿付き (¥3,000)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="vest_back_1" name="options_1" data-price="2000" onchange="updateTotalPrice()">
                                    <label for="vest_back_1">背共生地 (¥2,000)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="vest_double_1" name="options_1" data-price="3000" onchange="updateTotalPrice()">
                                    <label for="vest_double_1">ダブル (¥3,000)</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="price_1">価格（円）</label>
                                <input type="number" id="price_1" name="price_1" step="1000" onchange="updateTotalPrice()">
                            </div>
                            <div class="form-group">
                                <label for="deliveryDate_1">納期</label>
                                <input type="date" id="deliveryDate_1" name="deliveryDate_1">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes_1">備考</label>
                            <textarea id="notes_1" name="notes_1" rows="2" placeholder="特別な要望や注意事項"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 総計セクション -->
                <div class="total-section">
                    <h4 style="color: #2c3e50; margin: 0 0 15px 0;">価格総計</h4>
                    <div id="priceBreakdown"></div>
                    <div class="total-row grand-total">
                        <span>小計</span>
                        <span id="grandTotal">¥0</span>
                    </div>
                    
                    <!-- ディスカウントセクション -->
                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 120px;">
                                <label style="font-size: 12px; color: #856404;">割引率（%）</label>
                                <input type="number" id="discountPercent" min="0" max="100" step="0.1" 
                                       style="width: 100%; padding: 8px; border: 2px solid #ffeaa7; border-radius: 4px;"
                                       placeholder="10" onchange="updateDiscount('percent')">
                            </div>
                            <div style="padding-top: 20px;">または</div>
                            <div style="flex: 1; min-width: 150px;">
                                <label style="font-size: 12px; color: #856404;">割引額（円）</label>
                                <input type="number" id="discountAmount" min="0" step="100" 
                                       style="width: 100%; padding: 8px; border: 2px solid #ffeaa7; border-radius: 4px;"
                                       placeholder="5000" onchange="updateDiscount('amount')">
                            </div>
                        </div>
                        <div style="margin-top: 10px; text-align: right; color: #856404; font-weight: bold;">
                            割引額: <span id="discountDisplay" style="color: #d63031;">-¥0</span>
                        </div>
                    </div>
                    
                    <!-- 最終価格と内金・残金 -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #3498db;">
                        <div class="total-row grand-total" style="color: #2c3e50; font-size: 22px;">
                            <span>最終価格</span>
                            <span id="finalTotal">¥0</span>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <div class="total-row" style="color: #666;">
                                <span>内金</span>
                                <span id="depositDisplay">¥0</span>
                            </div>
                            <div class="total-row" style="font-weight: bold; color: #e74c3c; font-size: 18px;">
                                <span>残金</span>
                                <span id="balanceDisplay">¥0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- お支払い・納期セクション -->
        <div class="section" id="payment-section">
            <h2 class="section-title">💰 お支払い・納期</h2>
            <div class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentMethod">お支払い方法</label>
                        <select id="paymentMethod" name="paymentMethod">
                            <option value="">選択してください</option>
                            <option value="cash">現金</option>
                            <option value="card">クレジットカード</option>
                            <option value="transfer">銀行振込</option>
                            <option value="installment">分割払い</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deposit">内金（円）</label>
                        <input type="number" id="deposit" name="deposit" step="1000" onchange="updateBalance()">
                    </div>
                    <div class="form-group">
                        <label for="balance">残金（円）</label>
                        <input type="number" id="balance" name="balance" step="1000" readonly style="background-color: #f5f5f5;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderDate">受注日</label>
                        <input type="date" id="orderDate" name="orderDate">
                    </div>
                    <div class="form-group">
                        <label for="fittingDate">中縫い日</label>
                        <input type="date" id="fittingDate" name="fittingDate">
                    </div>
                    <div class="form-group">
                        <label for="completionDate">仕上がり予定日</label>
                        <input type="date" id="completionDate" name="completionDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- 備考・その他セクション -->
        <div class="section">
            <h2 class="section-title">📝 備考・その他</h2>
            <div class="section-content">
                <div class="form-group">
                    <label for="generalNotes">全般備考</label>
                    <textarea id="generalNotes" name="generalNotes" class="notes-area" placeholder="特別な要望、注意事項、その他"></textarea>
                </div>
            </div>
        </div>

        <!-- 保存ボタンエリア -->
        <div class="save-section">
            <h3 style="text-align: center; color: #2c3e50; margin: 20px 0;">データ管理</h3>
            
            <!-- 顧客切り替え機能 -->
            <div style="margin-bottom: 30px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                <h4 style="color: #1976d2; margin-bottom: 15px;">👥 複数顧客管理</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <select id="customerSelect" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 8px; border: 2px solid #1976d2;">
                        <option value="">顧客を選択...</option>
                    </select>
                    <button type="button" class="download-btn" style="background: linear-gradient(135deg, #1976d2, #1565c0); min-width: auto; padding: 10px 20px;" onclick="loadCustomerData()">読込</button>
                    <button type="button" class="download-btn" style="background: linear-gradient(135deg, #f44336, #d32f2f); min-width: auto; padding: 10px 20px;" onclick="deleteCustomerData()">削除</button>
                </div>
                <button type="button" class="download-btn" style="background: linear-gradient(135deg, #4caf50, #388e3c); width: 100%;" onclick="saveAsNewCustomer()">
                    ➕ 現在の入力を新規顧客として保存
                </button>
                <button type="button" class="download-btn" style="background: linear-gradient(135deg, #ff9800, #f57c00); width: 100%; margin-top: 10px;" onclick="updateCurrentCustomer()">
                    💾 現在の顧客データを上書き保存
                </button>
            </div>
            
            <!-- データ保存ボタン -->
            <button type="button" class="download-btn" onclick="saveToCSV()">📊 CSV保存（データ管理用）</button>
            
            <!-- 印刷・PDF出力 -->
            <button type="button" class="print-preview-btn download-btn" onclick="printPreview()">🖨️ A4印刷・PDF出力</button>
            
            <!-- バックアップ用 -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="text-align: center; color: #7f8c8d; font-size: 14px; margin-bottom: 10px;">その他のオプション</p>
                <button type="button" class="download-btn" onclick="window.print()">🖨️ 印刷・PDF出力</button>
                <button type="button" class="download-btn" onclick="clearForm()">🔄 フォームをクリア（新規入力）</button>
            </div>
        </div>
    </div>

    <!-- モーダルダイアログ（HTML本体の最後に追加） -->
    <div id="filenameModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📄 PDF保存用ファイル名</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">以下のファイル名をコピーして、PDF保存時にご使用ください。</p>
                <div id="filenameDisplay" class="filename-display" onclick="selectFilename()">
                    CRM顧客データ_山田太郎_20250612.pdf
                </div>
                <button id="copyButton" class="copy-button" onclick="copyFilename()">
                    <span id="copyIcon">📋</span>
                    <span id="copyText">ファイル名をコピー</span>
                </button>
                <div class="modal-instructions">
                    <h4>📝 使用手順</h4>
                    <ol>
                        <li>上記のファイル名をコピーします</li>
                        <li>「印刷を続ける」をクリックします</li>
                        <li>印刷ダイアログで「PDFとして保存」を選択します</li>
                        <li>ファイル名欄にペースト（Ctrl+V または Cmd+V）します</li>
                        <li>保存ボタンをクリックして完了です</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="closeModal()">キャンセル</button>
                <button class="modal-button primary" onclick="proceedToPrint()">印刷を続ける →</button>
            </div>
        </div>
    </div>

    <script>
// =====================================
// CRMオーダーシート 改善版JavaScript
// ===================================== 

// 基本設定とグローバル変数
const CRM_API_URL = 'https://script.google.com/macros/s/AKfycbxxap6gn_T7T5rRnCGfACRtQC6tXtSfNjWPtZ2ip4bftZ8JoR11un2u04mdSEpIHNDiHg/exec';
let itemCounter = 1;
let nextItemId = 2;
let currentCustomerId = null; // 現在編集中の顧客ID

// =============================================================================
// システム初期化
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('CRMシステム初期化中...');
    console.log('API URL:', CRM_API_URL);
    
    // 現在の日付と注文番号を設定
    const now = new Date();
    const dateStr = now.getFullYear() + '/' + 
                   String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                   String(now.getDate()).padStart(2, '0');
    
    const currentDateElement = document.getElementById('currentDate');
    if (currentDateElement) {
        currentDateElement.textContent = dateStr;
    }
    
    const orderNo = 'ORD' + now.getFullYear() + 
                   String(now.getMonth() + 1).padStart(2, '0') + 
                   String(now.getDate()).padStart(2, '0') + 
                   String(Math.floor(Math.random() * 1000)).padStart(3, '0');
    
    const orderNumberElement = document.getElementById('orderNumber');
    if (orderNumberElement) {
        orderNumberElement.textContent = orderNo;
    }

    // 必須項目機能の初期化
    initializeBirthDateDropdowns();
    setupRealTimeValidation();
    setupKanaAutoGeneration();
    setupMobileNavigation();
    
    // 基本機能の初期化
    updateItemCount();
    updateRemoveButtons();
    updateTotalPrice();
    checkEssentialFields();
    
    // 顧客リストの初期化
    loadCustomerList();
    
    // 自動バックアップ開始（localStorage利用可能な場合のみ）
    if (typeof(Storage) !== "undefined" && !isInSandbox()) {
        setupAutoBackup();
    }
    
    showStatusMessage('システムが初期化されました。', 'info');
    console.log('初期化完了');
});

// =============================================================================
// ステータスメッセージ機能
// =============================================================================

function showStatusMessage(message, type = 'info') {
    const statusDiv = document.getElementById('statusMessage');
    if (statusDiv) {
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    } else {
        alert(`${type.toUpperCase()}: ${message}`);
    }
}

// =============================================================================
// モバイルナビゲーション機能
// =============================================================================

function setupMobileNavigation() {
    // 全ての入力フィールドを取得（表示されているもののみ）
    const getVisibleInputs = () => {
        const allInputs = document.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), select, textarea');
        return Array.from(allInputs).filter(input => {
            const rect = input.getBoundingClientRect();
            return rect.width > 0 && rect.height > 0 && !input.disabled;
        });
    };

    // エンターキーで次のフィールドに移動
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            const activeElement = document.activeElement;
            
            // textareaの場合は改行を許可
            if (activeElement.tagName === 'TEXTAREA') {
                return;
            }
            
            // submitボタンの場合は何もしない
            if (activeElement.type === 'submit' || activeElement.type === 'button') {
                return;
            }
            
            e.preventDefault();
            
            const inputs = getVisibleInputs();
            const currentIndex = inputs.indexOf(activeElement);
            
            if (currentIndex >= 0 && currentIndex < inputs.length - 1) {
                const nextInput = inputs[currentIndex + 1];
                nextInput.focus();
                
                // スマホの場合、フィールドを画面中央に表示
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }
        
        // Shift+Enterで前のフィールドに戻る
        if (e.key === 'Enter' && e.shiftKey) {
            e.preventDefault();
            
            const inputs = getVisibleInputs();
            const currentIndex = inputs.indexOf(document.activeElement);
            
            if (currentIndex > 0) {
                const prevInput = inputs[currentIndex - 1];
                prevInput.focus();
                
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        prevInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }
        }
    });

    // タッチデバイス用の「次へ」ボタンを追加（オプション）
    if ('ontouchstart' in window) {
        addMobileNavigationButtons();
    }
    
    // フォーカス時にラベルをハイライト
    document.addEventListener('focusin', function(e) {
        if (e.target.matches('input, select, textarea')) {
            const formGroup = e.target.closest('.form-group');
            if (formGroup) {
                formGroup.classList.add('focused');
            }
        }
    });
    
    document.addEventListener('focusout', function(e) {
        if (e.target.matches('input, select, textarea')) {
            const formGroup = e.target.closest('.form-group');
            if (formGroup) {
                formGroup.classList.remove('focused');
            }
        }
    });
}

// モバイル用ナビゲーションボタンを追加
function addMobileNavigationButtons() {
    // 必須項目セクションに「次へ」ボタンを追加
    const essentialGroups = document.querySelectorAll('.essential-group');
    
    essentialGroups.forEach((group, index) => {
        if (index < essentialGroups.length - 1) {
            const nextButton = document.createElement('button');
            nextButton.type = 'button';
            nextButton.className = 'mobile-next-btn';
            nextButton.innerHTML = '次の項目へ →';
            nextButton.onclick = function() {
                const nextGroup = essentialGroups[index + 1];
                const firstInput = nextGroup.querySelector('input, select');
                if (firstInput) {
                    firstInput.focus();
                    nextGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };
            group.appendChild(nextButton);
        }
    });
}

// =============================================================================
// 必須項目バリデーション機能
// =============================================================================

function initializeBirthDateDropdowns() {
    const yearSelect = document.getElementById('birthYear');
    const daySelect = document.getElementById('birthDay');
    
    if (!yearSelect || !daySelect) {
        console.error('生年月日のセレクトボックスが見つかりません');
        return;
    }
    
    // 年の選択肢を生成
    yearSelect.innerHTML = '<option value="">----</option>';
    const currentYear = new Date().getFullYear();
    for (let year = currentYear; year >= 1920; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
    }
    
    // 日の初期選択肢を生成（1-31）
    daySelect.innerHTML = '<option value="">--</option>';
    for (let day = 1; day <= 31; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day + '日';
        daySelect.appendChild(option);
    }
    
    const monthSelect = document.getElementById('birthMonth');
    if (monthSelect) {
        monthSelect.addEventListener('change', updateDays);
    }
    if (yearSelect) {
        yearSelect.addEventListener('change', updateDays);
    }
}

function updateDays() {
    const yearSelect = document.getElementById('birthYear');
    const monthSelect = document.getElementById('birthMonth');
    const daySelect = document.getElementById('birthDay');
    
    if (!yearSelect || !monthSelect || !daySelect) return;
    
    const year = parseInt(yearSelect.value);
    const month = parseInt(monthSelect.value);
    
    daySelect.innerHTML = '<option value="">--</option>';
    
    if (year && month) {
        const daysInMonth = new Date(year, month, 0).getDate();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day + '日';
            daySelect.appendChild(option);
        }
    }
    
    updateBirthDateField();
}

function updateBirthDateField() {
    const year = document.getElementById('birthYear')?.value;
    const month = document.getElementById('birthMonth')?.value;
    const day = document.getElementById('birthDay')?.value;
    const birthDateField = document.getElementById('birthDate');
    
    if (year && month && day && birthDateField) {
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        birthDateField.value = formattedDate;
    }
    
    checkEssentialFields();
}

function setupRealTimeValidation() {
    // 統合名前フィールドのバリデーション
    const fullNameField = document.getElementById('fullName');
    if (fullNameField) {
        fullNameField.addEventListener('input', function() {
            validateField(this, 'nameCheck');
        });
    }
    
    const phoneField = document.getElementById('phone');
    if (phoneField) {
        phoneField.addEventListener('input', function() {
            validatePhoneNumber(this);
        });
    }
    
    const birthYearField = document.getElementById('birthYear');
    const birthMonthField = document.getElementById('birthMonth');
    const birthDayField = document.getElementById('birthDay');
    
    if (birthYearField) birthYearField.addEventListener('change', updateBirthDateField);
    if (birthMonthField) birthMonthField.addEventListener('change', updateBirthDateField);
    if (birthDayField) birthDayField.addEventListener('change', updateBirthDateField);
    
    const addressField = document.getElementById('address');
    const prefectureField = document.getElementById('prefecture');
    
    if (addressField) {
        addressField.addEventListener('input', function() {
            validateField(this, 'addressCheck');
        });
    }
    
    if (prefectureField) {
        prefectureField.addEventListener('change', function() {
            validateField(this, 'addressCheck');
        });
    }
}

function validateField(field, checkId) {
    const isValid = field.value.trim().length > 0;
    
    if (isValid) {
        field.classList.add('valid');
        field.classList.remove('invalid');
    } else {
        field.classList.remove('valid');
        field.classList.add('invalid');
    }
    
    checkEssentialFields();
}

function validatePhoneNumber(field) {
    const phoneRegex = /^[\d\-\(\)\+\s]{10,15}$/;
    const isValid = phoneRegex.test(field.value.trim());
    
    if (isValid) {
        field.classList.add('valid');
        field.classList.remove('invalid');
    } else {
        field.classList.remove('valid');
        if (field.value.trim().length > 0) {
            field.classList.add('invalid');
        }
    }
    
    checkEssentialFields();
}

function checkEssentialFields() {
    const checks = {
        name: checkNameComplete(),
        phone: checkPhoneComplete(),
        birth: checkBirthComplete(),
        address: checkAddressComplete()
    };
    
    updateCheckMark('nameCheck', checks.name);
    updateCheckMark('phoneCheck', checks.phone);
    updateCheckMark('birthCheck', checks.birth);
    updateCheckMark('addressCheck', checks.address);
    
    updateGroupStatus('name', checks.name);
    updateGroupStatus('phone', checks.phone);
    updateGroupStatus('birth', checks.birth);
    updateGroupStatus('address', checks.address);
    
    updateProgressBar(checks);
}

function checkNameComplete() {
    const fullName = document.getElementById('fullName')?.value.trim() || '';
    return fullName.length > 0;
}

function checkPhoneComplete() {
    const phone = document.getElementById('phone')?.value.trim() || '';
    const phoneRegex = /^[\d\-\(\)\+\s]{10,15}$/;
    return phoneRegex.test(phone);
}

function checkBirthComplete() {
    const year = document.getElementById('birthYear')?.value;
    const month = document.getElementById('birthMonth')?.value;
    const day = document.getElementById('birthDay')?.value;
    return year && month && day;
}

function checkAddressComplete() {
    const prefecture = document.getElementById('prefecture')?.value.trim() || '';
    const address = document.getElementById('address')?.value.trim() || '';
    return prefecture.length > 0 && address.length > 0;
}

function updateCheckMark(checkId, isComplete) {
    const checkMark = document.getElementById(checkId);
    if (checkMark) {
        if (isComplete) {
            checkMark.classList.add('visible');
        } else {
            checkMark.classList.remove('visible');
        }
    }
}

function updateGroupStatus(groupType, isComplete) {
    const groups = document.querySelectorAll('.essential-group');
    
    groups.forEach((group, index) => {
        const groupTypes = ['name', 'phone', 'birth', 'address'];
        if (groupTypes[index] === groupType) {
            if (isComplete) {
                group.classList.add('completed');
            } else {
                group.classList.remove('completed');
            }
        }
    });
}

function updateProgressBar(checks) {
    const completedCount = Object.values(checks).filter(Boolean).length;
    const totalCount = 4;
    const percentage = (completedCount / totalCount) * 100;
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    
    if (progressText) {
        progressText.textContent = `${completedCount}/${totalCount}`;
    }
    
    if (completedCount === totalCount) {
        showStatusMessage('✅ 必須項目の入力が完了しました！', 'success');
    }
}

// サンドボックス環境チェック
function isInSandbox() {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return false;
    } catch (e) {
        return true;
    }
}

// =============================================================================
// 住所検索機能（代替方法を含む）
// =============================================================================

function lookupAddress() {
    const postalCode = document.getElementById('postalCode')?.value.trim();
    
    if (!postalCode) {
        showStatusMessage('郵便番号を入力してください', 'info');
        return;
    }
    
    const cleanPostalCode = postalCode.replace(/[^0-9]/g, '');
    
    if (cleanPostalCode.length !== 7) {
        showStatusMessage('正しい郵便番号を入力してください（7桁）', 'error');
        return;
    }
    
    showStatusMessage('住所を検索中...', 'info');
    
    // 郵便番号API（プロキシ経由またはローカル環境でのみ動作）
    const apiUrl = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                const result = data.results[0];
                
                const prefectureSelect = document.getElementById('prefecture');
                if (prefectureSelect) {
                    prefectureSelect.value = result.address1;
                }
                
                const addressField = document.getElementById('address');
                if (addressField) {
                    addressField.value = result.address2 + result.address3;
                    addressField.focus();
                }
                
                showStatusMessage('✅ 住所を自動入力しました', 'success');
                checkEssentialFields();
            } else {
                showStatusMessage('❌ 住所が見つかりませんでした', 'error');
            }
        })
        .catch(error => {
            console.error('住所検索エラー:', error);
            // サンドボックス環境でのフォールバック
            showStatusMessage('❌ 住所検索機能は現在利用できません。手動で入力してください。', 'error');
            
            // 郵便番号フィールドにフォーカスを戻す
            const prefectureSelect = document.getElementById('prefecture');
            if (prefectureSelect) {
                prefectureSelect.focus();
            }
        });
}

// =============================================================================
// フリガナ自動生成機能
// =============================================================================

function setupKanaAutoGeneration() {
    let kanaTimeout;
    
    const fullNameField = document.getElementById('fullName');
    
    if (fullNameField) {
        fullNameField.addEventListener('input', function() {
            clearTimeout(kanaTimeout);
            kanaTimeout = setTimeout(() => {
                generateKana(this.value, 'fullNameKana');
            }, 1000);
        });
    }
}

function generateKana(name, targetId) {
    const kanaMap = {
        '田': 'ダ', '中': 'ナカ', '山': 'ヤマ', '佐': 'サ', '藤': 'トウ',
        '太': 'タ', '郎': 'ロウ', '花': 'ハナ', '子': 'コ', '美': 'ミ',
        '和': 'ワ', '雄': 'オ', '明': 'アキ', '博': 'ヒロ', '健': 'ケン',
        '木': 'キ', '村': 'ムラ', '上': 'ウエ', '下': 'シタ', '川': 'カワ',
        '井': 'イ', '林': 'ハヤシ', '森': 'モリ', '原': 'ハラ', '野': 'ノ'
    };
    
    const targetField = document.getElementById(targetId);
    if (!targetField || targetField.value.trim() !== '') return;
    
    let kana = '';
    for (let char of name) {
        kana += kanaMap[char] || char;
    }
    
    if (kana !== name) {
        targetField.value = kana;
    }
}

// =============================================================================
// 姓名分割ユーティリティ（互換性用）
// =============================================================================

function parseFullName(fullName) {
    if (!fullName) return { lastName: '', firstName: '' };
    
    // 全角・半角スペースで分割
    const parts = fullName.trim().split(/[　\s]+/);
    
    if (parts.length >= 2) {
        return {
            lastName: parts[0],
            firstName: parts.slice(1).join(' ')
        };
    }
    
    // スペースがない場合、2文字目で分割を試みる
    if (fullName.length >= 2) {
        // 一般的な姓の文字数パターンで判定
        const commonLastNameLengths = [1, 2, 3];
        for (let len of commonLastNameLengths) {
            if (fullName.length > len) {
                const possibleLastName = fullName.substring(0, len);
                const possibleFirstName = fullName.substring(len);
                
                // 2文字姓を優先
                if (len === 2) {
                    return {
                        lastName: possibleLastName,
                        firstName: possibleFirstName
                    };
                }
            }
        }
    }
    
    // デフォルトは全体を姓とする
    return {
        lastName: fullName,
        firstName: ''
    };
}

// =============================================================================
// データ収集機能（改善版）
// =============================================================================

function collectFormData() {
    updateBirthDateField();
    
    const formData = {};
    
    const orderNumberElement = document.getElementById('orderNumber');
    const currentDateElement = document.getElementById('currentDate');
    
    formData.orderNumber = orderNumberElement ? orderNumberElement.textContent : '';
    formData.orderDate = currentDateElement ? currentDateElement.textContent : '';
    
    // 統合名前フィールドから取得し、互換性のために分割も保存
    const fullName = document.getElementById('fullName')?.value || '';
    const fullNameKana = document.getElementById('fullNameKana')?.value || '';
    const nameParts = parseFullName(fullName);
    const kanaParts = parseFullName(fullNameKana);
    
    formData.fullName = fullName;
    formData.fullNameKana = fullNameKana;
    formData.lastName = nameParts.lastName;
    formData.firstName = nameParts.firstName;
    formData.lastNameKana = kanaParts.lastName;
    formData.firstNameKana = kanaParts.firstName;
    
    formData.birthDate = document.getElementById('birthDate')?.value || '';
    formData.gender = document.getElementById('gender')?.value || '';
    formData.occupation = document.getElementById('occupation')?.value || '';
    
    formData.postalCode = document.getElementById('postalCode')?.value || '';
    formData.prefecture = document.getElementById('prefecture')?.value || '';
    formData.address = document.getElementById('address')?.value || '';
    formData.phone = document.getElementById('phone')?.value || '';
    formData.referrer = document.getElementById('referrer')?.value || '';
    
    formData.measurements = {
        height: document.getElementById('height')?.value || '',
        weight: document.getElementById('weight')?.value || '',
        chest: document.getElementById('chest')?.value || '',
        waist: document.getElementById('waist')?.value || '',
        hip: document.getElementById('hip')?.value || '',
        shoulderWidth: document.getElementById('shoulderWidth')?.value || '',
        jacketLength: document.getElementById('jacketLength')?.value || '',
        neckSize: document.getElementById('neckSize')?.value || '',
        armLengthLeft: document.getElementById('armLengthLeft')?.value || '',
        armLengthRight: document.getElementById('armLengthRight')?.value || '',
        yokoLength: document.getElementById('yokoLength')?.value || '',
        armHole: document.getElementById('armHole')?.value || '',
        upperArmCircum: document.getElementById('upperArmCircum')?.value || '',
        elbowCircum: document.getElementById('elbowCircum')?.value || '',
        wristCircum: document.getElementById('wristCircum')?.value || '',
        vestLength: document.getElementById('vestLength')?.value || '',
        pantWaist: document.getElementById('pantWaist')?.value || '',
        crotchDepth: document.getElementById('crotchDepth')?.value || '',
        inseam: document.getElementById('inseam')?.value || '',
        pantTotalLength: document.getElementById('pantTotalLength')?.value || '',
        inseamActual: document.getElementById('inseamActual')?.value || '',
        thighCircum: document.getElementById('thighCircum')?.value || '',
        kneeCircum: document.getElementById('kneeCircum')?.value || '',
        calfCircum: document.getElementById('calfCircum')?.value || '',
        shoulderSlopeLeft: document.getElementById('shoulderSlopeLeft')?.value || '',
        shoulderSlopeRight: document.getElementById('shoulderSlopeRight')?.value || '',
        kamaDepth: document.getElementById('kamaDepth')?.value || '',
        strapLength: document.getElementById('strapLength')?.value || '',
        overShoulderLength: document.getElementById('overShoulderLength')?.value || '',
        bodyType: document.getElementById('bodyType')?.value || ''
    };
    
    formData.items = [];
    const items = document.querySelectorAll('.style-item');
    items.forEach(item => {
        const itemId = item.getAttribute('data-item');
        
        const options = [];
        let optionPrices = 0;
        const checkboxes = item.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling;
            if (label) {
                options.push(label.textContent);
                // オプション価格を計算
                const price = parseInt(checkbox.getAttribute('data-price')) || 0;
                optionPrices += price;
            }
        });
        
        const itemData = {
            id: itemId,
            itemType: document.getElementById(`itemType_${itemId}`)?.value || '',
            fabric: document.getElementById(`fabric_${itemId}`)?.value || '',
            color: document.getElementById(`color_${itemId}`)?.value || '',
            jacketStyle: document.getElementById(`jacketStyle_${itemId}`)?.value || '',
            liningType: document.getElementById(`liningType_${itemId}`)?.value || '',
            lining: document.getElementById(`lining_${itemId}`)?.value || '',
            buttons: document.getElementById(`buttons_${itemId}`)?.value || '',
            jacketFit: document.getElementById(`jacketFit_${itemId}`)?.value || '',
            pantsFit: document.getElementById(`pantsFit_${itemId}`)?.value || '',
            pantsShape: document.getElementById(`pantsShape_${itemId}`)?.value || '',
            chestPocket: document.getElementById(`chestPocket_${itemId}`)?.value || '',
            waistPocket: document.getElementById(`waistPocket_${itemId}`)?.value || '',
            lapelStyle: document.getElementById(`lapelStyle_${itemId}`)?.value || '',
            lapelWidth: document.getElementById(`lapelWidth_${itemId}`)?.value || '',
            cuffStyle: document.getElementById(`cuffStyle_${itemId}`)?.value || '',
            options: options,
            optionPrices: optionPrices,
            price: parseInt(document.getElementById(`price_${itemId}`)?.value) || 0,
            deliveryDate: document.getElementById(`deliveryDate_${itemId}`)?.value || '',
            notes: document.getElementById(`notes_${itemId}`)?.value || ''
        };
        formData.items.push(itemData);
    });
    
    formData.payment = {
        method: document.getElementById('paymentMethod')?.value || '',
        deposit: parseInt(document.getElementById('deposit')?.value) || 0,
        balance: parseInt(document.getElementById('balance')?.value) || 0,
        orderDate: document.getElementById('orderDate')?.value || '',
        fittingDate: document.getElementById('fittingDate')?.value || '',
        completionDate: document.getElementById('completionDate')?.value || '',
        discountPercent: parseFloat(document.getElementById('discountPercent')?.value) || 0,
        discountAmount: parseInt(document.getElementById('discountAmount')?.value) || 0
    };
    
    // 価格情報
    const grandTotalElement = document.getElementById('grandTotal');
    const finalTotalElement = document.getElementById('finalTotal');
    const subtotalText = grandTotalElement ? grandTotalElement.textContent : '¥0';
    const finalText = finalTotalElement ? finalTotalElement.textContent : '¥0';
    
    formData.subtotalPrice = parseInt(subtotalText.replace(/[¥,]/g, '')) || 0;
    formData.totalPrice = parseInt(finalText.replace(/[¥,]/g, '')) || 0;
    
    formData.generalNotes = document.getElementById('generalNotes')?.value || '';
    formData.timestamp = new Date().toISOString();
    
    return formData;
}

// 現在の顧客データを上書き保存
function updateCurrentCustomer() {
    if (!currentCustomerId) {
        showStatusMessage('❌ 顧客が選択されていません。新規保存してください。', 'error');
        return;
    }
    
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境では上書き保存機能が利用できません', 'info');
        return;
    }
    
    try {
        const formData = collectFormData();
        
        // 現在の顧客データを上書き
        localStorage.setItem(`customer_${currentCustomerId}`, JSON.stringify(formData));
        
        // 顧客リストの基本情報も更新
        const customers = JSON.parse(localStorage.getItem('customerList') || '{}');
        if (customers[currentCustomerId]) {
            customers[currentCustomerId].fullName = formData.fullName;
            customers[currentCustomerId].lastName = formData.lastName;
            customers[currentCustomerId].firstName = formData.firstName;
            customers[currentCustomerId].savedDate = new Date().toISOString();
            localStorage.setItem('customerList', JSON.stringify(customers));
        }
        
        // リストを更新
        loadCustomerList();
        
        showStatusMessage(`✅ ${formData.fullName}様のデータを更新しました`, 'success');
        
    } catch (error) {
        console.error('顧客更新エラー:', error);
        showStatusMessage('❌ 顧客データの更新に失敗しました', 'error');
    }
}

// =============================================================================
// 複数顧客管理機能
// =============================================================================

// 顧客リストを読み込み
function loadCustomerList() {
    if (isInSandbox()) return;
    
    try {
        const customers = JSON.parse(localStorage.getItem('customerList') || '{}');
        const selectElement = document.getElementById('customerSelect');
        
        if (selectElement) {
            // 現在の選択値を保存
            const currentValue = selectElement.value;
            
            selectElement.innerHTML = '<option value="">顧客を選択...</option>';
            
            // 顧客リストをソート（新しい順）
            const sortedCustomers = Object.entries(customers).sort((a, b) => {
                const dateA = new Date(a[1].savedDate || 0);
                const dateB = new Date(b[1].savedDate || 0);
                return dateB - dateA;
            });
            
            sortedCustomers.forEach(([customerId, customer]) => {
                const option = document.createElement('option');
                option.value = customerId;
                const savedDate = customer.savedDate ? new Date(customer.savedDate).toLocaleDateString('ja-JP') : '';
                const displayName = customer.fullName || `${customer.lastName} ${customer.firstName}`;
                option.textContent = `${displayName} (${savedDate})`;
                selectElement.appendChild(option);
            });
            
            // 選択値を復元
            if (currentValue) {
                selectElement.value = currentValue;
            }
        }
        
    } catch (e) {
        console.error('顧客リスト読み込みエラー:', e);
    }
}

// 新規顧客として保存
function saveAsNewCustomer() {
    const fullName = document.getElementById('fullName')?.value.trim();
    
    if (!fullName) {
        showStatusMessage('❌ お名前を入力してください', 'error');
        return;
    }
    
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境では顧客保存機能が利用できません', 'info');
        return;
    }
    
    try {
        // フォームデータを収集
        const formData = collectFormData();
        
        // 新しい顧客IDを生成（タイムスタンプベース）
        const now = new Date();
        const customerId = 'CUS' + now.getTime() + '_' + Math.floor(Math.random() * 1000);
        
        // 顧客リストを取得
        const customers = JSON.parse(localStorage.getItem('customerList') || '{}');
        
        // 顧客リストに基本情報を追加
        customers[customerId] = {
            customerId: customerId,
            fullName: formData.fullName,
            lastName: formData.lastName,
            firstName: formData.firstName,
            orderNumber: formData.orderNumber,
            savedDate: now.toISOString()
        };
        
        // 顧客リストを保存
        localStorage.setItem('customerList', JSON.stringify(customers));
        
        // 詳細データを個別に保存
        localStorage.setItem(`customer_${customerId}`, JSON.stringify(formData));
        
        // 現在の顧客IDを更新
        currentCustomerId = customerId;
        
        // リストを更新
        loadCustomerList();
        
        // 選択状態にする
        const selectElement = document.getElementById('customerSelect');
        if (selectElement) {
            selectElement.value = customerId;
        }
        
        showStatusMessage(`✅ ${fullName}様のデータを保存しました`, 'success');
        
    } catch (error) {
        console.error('顧客保存エラー:', error);
        showStatusMessage('❌ 顧客データの保存に失敗しました', 'error');
    }
}

// 顧客データを読み込み
function loadCustomerData() {
    const selectElement = document.getElementById('customerSelect');
    const customerId = selectElement?.value;
    
    if (!customerId) {
        showStatusMessage('顧客を選択してください', 'info');
        return;
    }
    
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境では顧客読込機能が利用できません', 'info');
        return;
    }
    
    try {
        const customerData = localStorage.getItem(`customer_${customerId}`);
        if (!customerData) {
            showStatusMessage('❌ 顧客データが見つかりません', 'error');
            return;
        }
        
        const data = JSON.parse(customerData);
        
        // 現在のデータがある場合は確認
        const fullName = document.getElementById('fullName')?.value;
        
        if (fullName) {
            if (!confirm('現在の入力内容は失われます。続行しますか？')) {
                return;
            }
        }
        
        // データを読み込む
        loadDataToForm(data);
        currentCustomerId = customerId;
        
        const displayName = data.fullName || `${data.lastName} ${data.firstName}`;
        showStatusMessage(`✅ ${displayName}様のデータを読み込みました`, 'success');
        
    } catch (error) {
        console.error('顧客データ読み込みエラー:', error);
        showStatusMessage('❌ 顧客データの読み込みに失敗しました', 'error');
    }
}

// 顧客データを削除
function deleteCustomerData() {
    const selectElement = document.getElementById('customerSelect');
    const customerId = selectElement?.value;
    
    if (!customerId) {
        showStatusMessage('削除する顧客を選択してください', 'info');
        return;
    }
    
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境では顧客削除機能が利用できません', 'info');
        return;
    }
    
    try {
        const customers = JSON.parse(localStorage.getItem('customerList') || '{}');
        const customer = customers[customerId];
        
        if (customer) {
            const displayName = customer.fullName || `${customer.lastName} ${customer.firstName}`;
            if (confirm(`${displayName}様のデータを削除しますか？\nこの操作は取り消せません。`)) {
                // 顧客リストから削除
                delete customers[customerId];
                localStorage.setItem('customerList', JSON.stringify(customers));
                
                // 個別データも削除
                localStorage.removeItem(`customer_${customerId}`);
                
                // 現在編集中の顧客の場合はクリア
                if (currentCustomerId === customerId) {
                    currentCustomerId = null;
                    clearForm();
                }
                
                // リストを更新
                loadCustomerList();
                
                showStatusMessage(`✅ ${displayName}様のデータを削除しました`, 'success');
            }
        }
    } catch (error) {
        console.error('顧客削除エラー:', error);
        showStatusMessage('❌ 顧客データの削除に失敗しました', 'error');
    }
}

// フォームをクリア
function clearForm() {
    if (confirm('すべての入力内容をクリアしますか？')) {
        // すべての入力フィールドをクリア
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"], textarea');
        inputs.forEach(input => {
            input.value = '';
            input.classList.remove('valid', 'invalid');
        });
        
        // セレクトボックスをリセット
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.selectedIndex = 0;
        });
        
        // チェックボックスをクリア
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // 生年月日の隠しフィールドもクリア
        const birthDateField = document.getElementById('birthDate');
        if (birthDateField) {
            birthDateField.value = '';
        }
        
        // 新しい注文番号を生成
        const now = new Date();
        const orderNo = 'ORD' + now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0') + 
                       String(Math.floor(Math.random() * 1000)).padStart(3, '0');
        
        const orderNumberElement = document.getElementById('orderNumber');
        if (orderNumberElement) {
            orderNumberElement.textContent = orderNo;
        }
        
        // 現在の顧客IDをクリア
        currentCustomerId = null;
        
        // 顧客選択もリセット
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
            customerSelect.selectedIndex = 0;
        }
        
        // アイテムを1つにリセット
        const container = document.getElementById('styleItemsContainer');
        if (container) {
            // 既存のアイテムをすべて削除
            container.innerHTML = '';
            
            // アイテムカウンターをリセット
            itemCounter = 0;
            nextItemId = 1;
            
            // 新しいアイテムを1つ追加
            addStyleItem();
        }
        
        // 状態を更新
        checkEssentialFields();
        updateTotalPrice();
        
        showStatusMessage('✅ フォームをクリアしました', 'success');
    }
}

// 自動保存機能を修正（現在の顧客に上書き保存）
function autoSaveCurrentCustomer() {
    if (currentCustomerId && !isInSandbox()) {
        try {
            const formData = collectFormData();
            localStorage.setItem(`customer_${currentCustomerId}`, JSON.stringify(formData));
            console.log(`顧客 ${currentCustomerId} のデータを自動保存しました`);
        } catch (e) {
            console.error('自動保存エラー:', e);
        }
    }
}

// =============================================================================
// 実用的な保存機能
// =============================================================================

// データ管理用CSV保存（CRM顧客マスター対応版）
function saveToCSV() {
    try {
        const formData = collectFormData();
        
        // Google Sheets顧客マスターの列順に合わせたヘッダー（改善版）
        const headers = [
            '顧客ID', '姓', '名', 'フリガナ（姓）', 'フリガナ（名）', '生年月日', '性別', '職業',
            '郵便番号', '都道府県', '住所', '電話番号', '紹介者',
            '身長', '体重', '胸囲', 'ウエスト', 'ヒップ', '肩幅', '上着丈', '首回り',
            '袖丈左', '袖丈右', '裄丈', 'AH', '二の腕周り', '肘周り', '手首周り',
            'ベスト丈', 'パンツウエスト', '股上', '股下', 'パンツ総丈', 'パンツ股下実寸',
            '太もも周り', '膝周り', 'ふくらはぎ周り',
            '肩傾斜左', '肩傾斜右', '鎌深', 'ストラップ寸', 'オーバーショルダー寸',
            'アイテムNo', 'アイテムタイプ', '生地', '色', 'ジャケットスタイル', '裏地仕様', '裏地', 'ボタン',
            'ジャケットフィット', 'パンツフィット', 'パンツ形状',
            '胸ポケット', '腰ポケット', '衿型', '衿幅', 'カフス', 'オプション', '価格', '納期', 'アイテム備考',
            '小計', '割引率(%)', '割引額', '総額', '支払方法', '内金', '残金', '全体備考', '受注日', '注文番号'
        ];
        
        // 複数アイテムを各行に展開するための配列
        const rows = [];
        
        // アイテムがない場合でも最低1行は出力
        if (formData.items.length === 0) {
            formData.items.push({});
        }
        
        // 各アイテムごとに行を作成
        formData.items.forEach((item, index) => {
            const values = [
                formData.orderNumber, // 顧客ID
                formData.lastName,
                formData.firstName,
                formData.lastNameKana,
                formData.firstNameKana,
                formData.birthDate,
                formData.gender === 'male' ? '男性' : formData.gender === 'female' ? '女性' : formData.gender,
                formData.occupation,
                formData.postalCode,
                formData.prefecture,
                formData.address,
                formData.phone,
                formData.referrer,
                formData.measurements.height,
                formData.measurements.weight,
                formData.measurements.chest,
                formData.measurements.waist,
                formData.measurements.hip,
                formData.measurements.shoulderWidth,
                formData.measurements.jacketLength,
                formData.measurements.neckSize,
                formData.measurements.armLengthLeft,
                formData.measurements.armLengthRight,
                formData.measurements.yokoLength,
                formData.measurements.armHole,
                formData.measurements.upperArmCircum,
                formData.measurements.elbowCircum,
                formData.measurements.wristCircum,
                formData.measurements.vestLength,
                formData.measurements.pantWaist,
                formData.measurements.crotchDepth,
                formData.measurements.inseam,
                formData.measurements.pantTotalLength || '',
                formData.measurements.inseamActual || '',
                formData.measurements.thighCircum,
                formData.measurements.kneeCircum,
                formData.measurements.calfCircum,
                formData.measurements.shoulderSlopeLeft || '',
                formData.measurements.shoulderSlopeRight || '',
                formData.measurements.kamaDepth || '',
                formData.measurements.strapLength || '',
                formData.measurements.overShoulderLength || '',
                // アイテム情報
                index + 1, // アイテムNo
                item.itemType || '',
                item.fabric || '',
                item.color || '',
                item.jacketStyle === 'single_2x1' ? 'シングル２×１' : 
                item.jacketStyle === 'single_1x1' ? 'シングル１×１' : 
                item.jacketStyle === 'single_3x1' ? 'シングル３×１' : 
                item.jacketStyle === 'double_6x2' ? 'ダブル６×２' : 
                item.jacketStyle === 'double_4x2' ? 'ダブル４×２' : 
                item.jacketStyle === 'double_2x1' ? 'ダブル２×１' : item.jacketStyle || '',
                item.liningType === 'senuki' ? '背抜き' :
                item.liningType === 'soura' ? '総裏' : item.liningType || '',
                item.lining || '',
                item.buttons || '',
                item.jacketFit === 'tight' ? 'タイトフィット' :
                item.jacketFit === 'basic' ? 'ベーシックフィット' :
                item.jacketFit === 'loose' ? 'ルーズフィット' : item.jacketFit || '',
                item.pantsFit === 'tight' ? 'タイトフィット' :
                item.pantsFit === 'basic' ? 'ベーシックフィット' :
                item.pantsFit === 'loose' ? 'ルーズフィット' : item.pantsFit || '',
                item.pantsShape === 'tapered' ? 'テーパード' :
                item.pantsShape === 'straight' ? 'ストレート' :
                item.pantsShape === 'wide' ? 'ワイド' :
                item.pantsShape === 'slight_flare' ? '少しフレア' :
                item.pantsShape === 'flare' ? 'フレア' : item.pantsShape || '',
                // 胸ポケット
                item.chestPocket === 'barca' ? 'バルカポケット' :
                item.chestPocket === 'box' ? '箱ポケット' :
                item.chestPocket === 'out' ? 'アウトポケット' : item.chestPocket || '',
                // 腰ポケット
                item.waistPocket === 'flap' ? 'フラップポケット' :
                item.waistPocket === 'out' ? 'アウトポケット' :
                item.waistPocket === 'double_piping' ? '両玉縁ポケット（フラップなし）' :
                item.waistPocket === 'change' ? 'チェンジポケット' :
                item.waistPocket === 'hacking' ? 'ハッキングポケット' :
                item.waistPocket === 'hacking_change' ? 'ハッキングチェンジP' : item.waistPocket || '',
                item.lapelStyle || '',
                item.lapelWidth ? item.lapelWidth + 'cm' : '',
                item.cuffStyle || '',
                item.options ? item.options.join('、') : '', // オプションをカンマ区切りで結合
                item.price || '',
                item.deliveryDate || '',
                item.notes || '',
                // 価格情報（全行で同じ）
                formData.subtotalPrice || 0, // 小計
                formData.payment.discountPercent || 0, // 割引率
                formData.payment.discountAmount || 0, // 割引額
                formData.totalPrice, // 総額（割引後）
                formData.payment.method === 'cash' ? '現金' : 
                formData.payment.method === 'card' ? 'クレジットカード' : 
                formData.payment.method === 'transfer' ? '銀行振込' : 
                formData.payment.method === 'installment' ? '分割払い' : formData.payment.method,
                formData.payment.deposit,
                formData.payment.balance,
                formData.generalNotes,
                formData.orderDate, // 現在の日付
                formData.orderNumber // 注文番号
            ];
            
            rows.push(values);
        });
        
        // CSV作成
        const csvContent = [
            headers.join(','),
            ...rows.map(row => 
                row.map((v, index) => {
                    const str = String(v || '');
                    
                    // 電話番号の場合は先頭に'を付けてExcelで文字列として認識させる
                    if (headers[index] === '電話番号' && str !== '') {
                        return `"'${str}"`;
                    }
                    
                    // 数値の場合はそのまま、文字列の場合は必要に応じてクォート
                    if (!isNaN(str) && str !== '' && headers[index] !== '電話番号') {
                        return str;
                    }
                    // カンマ、改行、ダブルクォートを含む場合はクォートで囲む
                    if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                }).join(',')
            )
        ].join('\n');
        
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
        
        const now = new Date();
        const dateStr = now.getFullYear() + 
                       String(now.getMonth() + 1).padStart(2, '0') + 
                       String(now.getDate()).padStart(2, '0');
        
        const customerName = formData.fullName || 'データ';
        const filename = `CRM顧客データ_${customerName}_${dateStr}.csv`;
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatusMessage(`✅ CRM顧客マスター用CSVとして保存しました: ${filename}`, 'success');
        
    } catch (error) {
        console.error('CSV保存エラー:', error);
        showStatusMessage('❌ CSV保存に失敗しました', 'error');
    }
}

// バックアップ保存（入力途中のデータを保存）
function saveBackupData() {
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境ではバックアップ機能が利用できません', 'info');
        return;
    }
    
    try {
        const formData = collectFormData();
        
        // ブラウザのローカルストレージに保存
        localStorage.setItem('orderSheetBackup', JSON.stringify(formData));
        localStorage.setItem('orderSheetBackupDate', new Date().toISOString());
        
        showStatusMessage('✅ データをバックアップしました。ブラウザを閉じても保持されます。', 'success');
        
    } catch (error) {
        console.error('バックアップエラー:', error);
        showStatusMessage('❌ バックアップに失敗しました', 'error');
    }
}

// バックアップ読み込み
function loadBackupData() {
    if (isInSandbox()) {
        showStatusMessage('⚠️ この環境ではバックアップ機能が利用できません', 'info');
        return;
    }
    
    try {
        const backupData = localStorage.getItem('orderSheetBackup');
        const backupDate = localStorage.getItem('orderSheetBackupDate');
        
        if (!backupData) {
            showStatusMessage('バックアップデータが見つかりません', 'info');
            return;
        }
        
        const data = JSON.parse(backupData);
        const date = new Date(backupDate);
        const dateStr = date.toLocaleString('ja-JP');
        
        if (confirm(`${dateStr} のバックアップデータを読み込みますか？\n現在の入力内容は上書きされます。`)) {
            loadDataToForm(data);
            showStatusMessage(`✅ バックアップデータを読み込みました（${dateStr}）`, 'success');
        }
        
    } catch (error) {
        console.error('バックアップ読み込みエラー:', error);
        showStatusMessage('❌ バックアップの読み込みに失敗しました', 'error');
    }
}

// 自動バックアップ機能（5分ごと）
function setupAutoBackup() {
    if (isInSandbox()) {
        console.log('サンドボックス環境では自動バックアップは利用できません');
        return;
    }
    
    setInterval(() => {
        const fullName = document.getElementById('fullName')?.value;
        
        // 名前が入力されている場合
        if (fullName) {
            try {
                if (currentCustomerId) {
                    // 既存顧客の場合は上書き保存
                    autoSaveCurrentCustomer();
                } else {
                    // 新規の場合は一時バックアップ
                    const formData = collectFormData();
                    localStorage.setItem('orderSheetBackup', JSON.stringify(formData));
                    localStorage.setItem('orderSheetBackupDate', new Date().toISOString());
                }
                console.log('自動バックアップ完了:', new Date().toLocaleString());
            } catch (e) {
                console.log('自動バックアップエラー:', e);
            }
        }
    }, 5 * 60 * 1000); // 5分ごと
}

function loadDataToForm(data) {
    try {
        // フォームを一旦クリア（確認なし）
        clearFormWithoutConfirm();
        
        // 基本情報
        if (data.orderNumber) {
            const orderNumberElement = document.getElementById('orderNumber');
            if (orderNumberElement) {
                orderNumberElement.textContent = data.orderNumber;
            }
        }
        
        // 統合名前フィールドへの読み込み（互換性対応）
        if (data.fullName) {
            document.getElementById('fullName').value = data.fullName;
        } else if (data.lastName || data.firstName) {
            // 旧データ形式の場合
            document.getElementById('fullName').value = 
                `${data.lastName || ''} ${data.firstName || ''}`.trim();
        }
        
        if (data.fullNameKana) {
            document.getElementById('fullNameKana').value = data.fullNameKana;
        } else if (data.lastNameKana || data.firstNameKana) {
            // 旧データ形式の場合
            document.getElementById('fullNameKana').value = 
                `${data.lastNameKana || ''} ${data.firstNameKana || ''}`.trim();
        }
        
        if (data.phone) document.getElementById('phone').value = data.phone;
        if (data.referrer) document.getElementById('referrer').value = data.referrer;
        if (data.gender) document.getElementById('gender').value = data.gender;
        if (data.occupation) document.getElementById('occupation').value = data.occupation;
        
        // 生年月日
        if (data.birthDate) {
            const birthParts = data.birthDate.split('-');
            if (birthParts.length === 3) {
                const birthYear = document.getElementById('birthYear');
                const birthMonth = document.getElementById('birthMonth');
                const birthDay = document.getElementById('birthDay');
                
                if (birthYear) birthYear.value = birthParts[0];
                if (birthMonth) birthMonth.value = parseInt(birthParts[1]);
                
                // 日の選択肢を更新してから値を設定
                updateDays();
                setTimeout(() => {
                    if (birthDay) birthDay.value = parseInt(birthParts[2]);
                }, 100);
            }
        }
        
        // 住所
        if (data.postalCode) document.getElementById('postalCode').value = data.postalCode;
        if (data.prefecture) document.getElementById('prefecture').value = data.prefecture;
        if (data.address) document.getElementById('address').value = data.address;
        
        // 採寸情報
        if (data.measurements) {
            Object.keys(data.measurements).forEach(key => {
                const element = document.getElementById(key);
                if (element && data.measurements[key]) {
                    element.value = data.measurements[key];
                }
            });
        }
        
        // アイテム情報
        if (data.items && data.items.length > 0) {
            const container = document.getElementById('styleItemsContainer');
            if (container) {
                // 既存のアイテムをクリア
                container.innerHTML = '';
                itemCounter = 0;
                nextItemId = 1;
                
                // 保存されたアイテムを復元
                data.items.forEach((item, index) => {
                    addStyleItem();
                    
                    // アイテムのデータを設定
                    const itemId = nextItemId - 1;
                    
                    if (item.itemType) {
                        const itemTypeElement = document.getElementById(`itemType_${itemId}`);
                        if (itemTypeElement) itemTypeElement.value = item.itemType;
                    }
                    if (item.fabric) {
                        const fabricElement = document.getElementById(`fabric_${itemId}`);
                        if (fabricElement) fabricElement.value = item.fabric;
                    }
                    if (item.color) {
                        const colorElement = document.getElementById(`color_${itemId}`);
                        if (colorElement) colorElement.value = item.color;
                    }
                    if (item.jacketStyle) {
                        const jacketStyleElement = document.getElementById(`jacketStyle_${itemId}`);
                        if (jacketStyleElement) jacketStyleElement.value = item.jacketStyle;
                    }
                    if (item.liningType) {
                        const liningTypeElement = document.getElementById(`liningType_${itemId}`);
                        if (liningTypeElement) liningTypeElement.value = item.liningType;
                    }
                    if (item.lining) {
                        const liningElement = document.getElementById(`lining_${itemId}`);
                        if (liningElement) liningElement.value = item.lining;
                    }
                    if (item.buttons) {
                        const buttonsElement = document.getElementById(`buttons_${itemId}`);
                        if (buttonsElement) buttonsElement.value = item.buttons;
                    }
                    if (item.jacketFit) {
                        const jacketFitElement = document.getElementById(`jacketFit_${itemId}`);
                        if (jacketFitElement) jacketFitElement.value = item.jacketFit;
                    }
                    if (item.pantsFit) {
                        const pantsFitElement = document.getElementById(`pantsFit_${itemId}`);
                        if (pantsFitElement) pantsFitElement.value = item.pantsFit;
                    }
                    if (item.pantsShape) {
                        const pantsShapeElement = document.getElementById(`pantsShape_${itemId}`);
                        if (pantsShapeElement) pantsShapeElement.value = item.pantsShape;
                    }
                    if (item.chestPocket) {
                        const chestPocketElement = document.getElementById(`chestPocket_${itemId}`);
                        if (chestPocketElement) chestPocketElement.value = item.chestPocket;
                    }
                    if (item.waistPocket) {
                        const waistPocketElement = document.getElementById(`waistPocket_${itemId}`);
                        if (waistPocketElement) waistPocketElement.value = item.waistPocket;
                    }
                    if (item.lapelStyle) {
                        const lapelElement = document.getElementById(`lapelStyle_${itemId}`);
                        if (lapelElement) lapelElement.value = item.lapelStyle;
                    }
                    if (item.lapelWidth) {
                        const lapelWidthElement = document.getElementById(`lapelWidth_${itemId}`);
                        if (lapelWidthElement) lapelWidthElement.value = item.lapelWidth;
                    }
                    if (item.cuffStyle) {
                        const cuffElement = document.getElementById(`cuffStyle_${itemId}`);
                        if (cuffElement) cuffElement.value = item.cuffStyle;
                    }
                    if (item.price) {
                        const priceElement = document.getElementById(`price_${itemId}`);
                        if (priceElement) priceElement.value = item.price;
                    }
                    if (item.deliveryDate) {
                        const deliveryDateElement = document.getElementById(`deliveryDate_${itemId}`);
                        if (deliveryDateElement) deliveryDateElement.value = item.deliveryDate;
                    }
                    if (item.notes) {
                        const notesElement = document.getElementById(`notes_${itemId}`);
                        if (notesElement) notesElement.value = item.notes;
                    }
                    
                    // オプション（チェックボックス）
                    if (item.options && Array.isArray(item.options)) {
                        item.options.forEach(option => {
                            const checkboxes = document.querySelectorAll(`[data-item="${itemId}"] input[type="checkbox"]`);
                            checkboxes.forEach(checkbox => {
                                const label = checkbox.nextElementSibling;
                                if (label && label.textContent === option) {
                                    checkbox.checked = true;
                                }
                            });
                        });
                    }
                });
            }
        }
        
        // 支払い情報
        if (data.payment) {
            if (data.payment.method) document.getElementById('paymentMethod').value = data.payment.method;
            if (data.payment.deposit) document.getElementById('deposit').value = data.payment.deposit;
            if (data.payment.balance) document.getElementById('balance').value = data.payment.balance;
            if (data.payment.orderDate) document.getElementById('orderDate').value = data.payment.orderDate;
            if (data.payment.fittingDate) document.getElementById('fittingDate').value = data.payment.fittingDate;
            if (data.payment.completionDate) document.getElementById('completionDate').value = data.payment.completionDate;
            if (data.payment.discountPercent) document.getElementById('discountPercent').value = data.payment.discountPercent;
            if (data.payment.discountAmount) document.getElementById('discountAmount').value = data.payment.discountAmount;
        }
        
        // 備考
        if (data.generalNotes) document.getElementById('generalNotes').value = data.generalNotes;
        
        updateTotalPrice();
        checkEssentialFields();
        
    } catch (error) {
        console.error('データ読み込みエラー:', error);
        showStatusMessage('❌ データの読み込み中にエラーが発生しました', 'error');
    }
}

// 確認なしでフォームをクリアする関数
function clearFormWithoutConfirm() {
    // すべての入力フィールドをクリア
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], input[type="date"], textarea');
    inputs.forEach(input => {
        input.value = '';
        input.classList.remove('valid', 'invalid');
    });
    
    // セレクトボックスをリセット
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        select.selectedIndex = 0;
    });
    
    // チェックボックスをクリア
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // 生年月日の隠しフィールドもクリア
    const birthDateField = document.getElementById('birthDate');
    if (birthDateField) {
        birthDateField.value = '';
    }
}

// =============================================================================
// スタイルアイテム管理機能
// =============================================================================

function addStyleItem() {
    const container = document.getElementById('styleItemsContainer');
    if (!container) return;
    
    const itemId = nextItemId;
    
    const itemHTML = `
        <div class="style-item adding" data-item="${itemId}">
            <div class="item-header">
                <h5>アイテム ${itemId}</h5>
                <button type="button" class="remove-item-btn" onclick="removeStyleItem(${itemId})">削除</button>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="itemType_${itemId}">アイテムタイプ</label>
                    <select id="itemType_${itemId}" name="itemType_${itemId}">
                        <option value="">選択してください</option>
                        <option value="Suit(2P)">Suit(2P)</option>
                        <option value="Suit(3P)">Suit(3P)</option>
                        <option value="Suit+Pants">Suit+Pants</option>
                        <option value="Suit(3P)+Pants">Suit(3P)+Pants</option>
                        <option value="Jacket(S)">Jacket(S)</option>
                        <option value="Jacket(D)">Jacket(D)</option>
                        <option value="Vest">Vest</option>
                        <option value="Pants">Pants</option>
                        <option value="D Suit">D Suit</option>
                        <option value="D Suit(3P)">D Suit(3P)</option>
                        <option value="D Suit+Pants">D Suit+Pants</option>
                        <option value="D Suit(3P)+Pants">D Suit(3P)+Pants</option>
                        <option value="Shirts">Shirts</option>
                        <option value="Tie">Tie</option>
                        <option value="Repair">Repair</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fabric_${itemId}">生地</label>
                    <input type="text" id="fabric_${itemId}" name="fabric_${itemId}" placeholder="生地番号・名称">
                </div>
                <div class="form-group">
                    <label for="color_${itemId}">色</label>
                    <input type="text" id="color_${itemId}" name="color_${itemId}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="jacketStyle_${itemId}">ジャケットスタイル</label>
                    <select id="jacketStyle_${itemId}" name="jacketStyle_${itemId}">
                        <option value="">選択してください</option>
                        <optgroup label="シングル">
                            <option value="single_2x1">シングル２×１</option>
                            <option value="single_1x1">シングル１×１</option>
                            <option value="single_3x1">シングル３×１</option>
                        </optgroup>
                        <optgroup label="ダブル">
                            <option value="double_6x2">ダブル６×２</option>
                            <option value="double_4x2">ダブル４×２</option>
                            <option value="double_2x1">ダブル２×１</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="liningType_${itemId}">裏地仕様</label>
                    <select id="liningType_${itemId}" name="liningType_${itemId}">
                        <option value="">選択してください</option>
                        <option value="senuki">背抜き</option>
                        <option value="soura">総裏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lining_${itemId}">裏地</label>
                    <input type="text" id="lining_${itemId}" name="lining_${itemId}" placeholder="裏地の種類・色">
                </div>
                <div class="form-group">
                    <label for="buttons_${itemId}">ボタン</label>
                    <input type="text" id="buttons_${itemId}" name="buttons_${itemId}" placeholder="ボタンの種類・材質">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="jacketFit_${itemId}">ジャケットフィット</label>
                    <select id="jacketFit_${itemId}" name="jacketFit_${itemId}">
                        <option value="">選択してください</option>
                        <option value="tight">タイトフィット</option>
                        <option value="basic">ベーシックフィット</option>
                        <option value="loose">ルーズフィット</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pantsFit_${itemId}">パンツフィット</label>
                    <select id="pantsFit_${itemId}" name="pantsFit_${itemId}">
                        <option value="">選択してください</option>
                        <option value="tight">タイトフィット</option>
                        <option value="basic">ベーシックフィット</option>
                        <option value="loose">ルーズフィット</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pantsShape_${itemId}">パンツ形状</label>
                    <select id="pantsShape_${itemId}" name="pantsShape_${itemId}">
                        <option value="">選択してください</option>
                        <option value="tapered">テーパード</option>
                        <option value="straight">ストレート</option>
                        <option value="wide">ワイド</option>
                        <option value="slight_flare">少しフレア</option>
                        <option value="flare">フレア</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="chestPocket_${itemId}">胸ポケット</label>
                    <select id="chestPocket_${itemId}" name="chestPocket_${itemId}">
                        <option value="">選択してください</option>
                        <option value="barca">バルカポケット</option>
                        <option value="box">箱ポケット</option>
                        <option value="out">アウトポケット</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="waistPocket_${itemId}">腰ポケット</label>
                    <select id="waistPocket_${itemId}" name="waistPocket_${itemId}">
                        <option value="">選択してください</option>
                        <option value="flap">フラップポケット</option>
                        <option value="out">アウトポケット</option>
                        <option value="double_piping">両玉縁ポケット（フラップなし）</option>
                        <option value="change">チェンジポケット</option>
                        <option value="hacking">ハッキングポケット</option>
                        <option value="hacking_change">ハッキングチェンジP</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="lapelStyle_${itemId}">衿型（ラペル・カラー）</label>
                    <select id="lapelStyle_${itemId}" name="lapelStyle_${itemId}">
                        <option value="">選択してください</option>
                        <optgroup label="ジャケット・スーツ">
                            <option value="notched">ノッチドラペル（一般的）</option>
                            <option value="peaked">ピークドラペル（剣先）</option>
                            <option value="shawl">ショールカラー</option>
                            <option value="narrow">ナローラペル</option>
                            <option value="wide">ワイドラペル</option>
                        </optgroup>
                        <optgroup label="シャツカラー">
                            <option value="regular_collar">レギュラーカラー</option>
                            <option value="semi_wide_collar">セミワイドカラー</option>
                            <option value="wide_collar">ワイドカラー</option>
                            <option value="horizontal_wide_collar">ホリゾンタルワイドカラー</option>
                            <option value="round_collar">ラウンドカラー</option>
                            <option value="open_collar">オープンカラー</option>
                            <option value="stand_collar">スタンドカラー</option>
                            <option value="wing_collar">ウィングカラー</option>
                            <option value="short_regular_collar">ショートレギュラーカラー</option>
                            <option value="short_semi_wide_collar">ショートセミワイドカラー</option>
                            <option value="short_wide_collar">ショートワイドカラー</option>
                            <option value="short_horizontal_wide_collar">ショートホリゾンタルワイドカラー</option>
                            <option value="short_round_collar">ショートラウンドカラー</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lapelWidth_${itemId}">衿幅</label>
                    <select id="lapelWidth_${itemId}" name="lapelWidth_${itemId}">
                        <option value="">選択してください</option>
                        <option value="5">5cm</option>
                        <option value="5.5">5.5cm</option>
                        <option value="6">6cm</option>
                        <option value="6.5">6.5cm</option>
                        <option value="7">7cm</option>
                        <option value="7.5">7.5cm</option>
                        <option value="8">8cm</option>
                        <option value="8.5">8.5cm</option>
                        <option value="9">9cm</option>
                        <option value="9.5">9.5cm</option>
                        <option value="10">10cm</option>
                        <option value="10.5">10.5cm</option>
                        <option value="11">11cm</option>
                        <option value="11.5">11.5cm</option>
                        <option value="12">12cm</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cuffStyle_${itemId}">カフス（袖口）</label>
                    <select id="cuffStyle_${itemId}" name="cuffStyle_${itemId}">
                        <option value="">選択してください</option>
                        <optgroup label="ジャケット・スーツ">
                            <option value="4button">4つボタン本切羽</option>
                            <option value="3button">3つボタン本切羽</option>
                            <option value="4button_fake">4つボタン（飾り）</option>
                            <option value="3button_fake">3つボタン（飾り）</option>
                            <option value="surgeons">サージャンカフス</option>
                            <option value="kissing">キッシングボタン</option>
                        </optgroup>
                        <optgroup label="シャツカフス">
                            <option value="regular_no_opening">レギュラー（開きなし）</option>
                            <option value="small_round">小丸</option>
                            <option value="round_b">ラウンドB</option>
                            <option value="round_c">ラウンドC</option>
                            <option value="cut_corner">角落ち</option>
                            <option value="corn">コーン</option>
                            <option value="turn_up">ターンナップ</option>
                            <option value="double_cuff">ダブル</option>
                            <option value="arrow">アロー</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>オプション</label>
                <div class="checkbox-group">
                    <div style="width: 100%; margin-bottom: 10px;">
                        <strong style="color: #2c3e50;">ジャケットオプション</strong>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="full_stitch_${itemId}" name="options_${itemId}" data-price="1500" onchange="updateTotalPrice()">
                        <label for="full_stitch_${itemId}">フルステッチ (¥1,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="functional_sleeves_${itemId}" name="options_${itemId}" data-price="1500" onchange="updateTotalPrice()">
                        <label for="functional_sleeves_${itemId}">本切羽 (¥1,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="buttonhole_color_${itemId}" name="options_${itemId}" data-price="1500" onchange="updateTotalPrice()">
                        <label for="buttonhole_color_${itemId}">ボタンホール色変え (¥1,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="kurumi_button_${itemId}" name="options_${itemId}" data-price="1500" onchange="updateTotalPrice()">
                        <label for="kurumi_button_${itemId}">クルミ釦 (¥1,500)</label>
                    </div>
                    
                    <div style="width: 100%; margin: 10px 0;">
                        <strong style="color: #2c3e50;">裏地オプション</strong>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="lining_a_${itemId}" name="options_${itemId}" data-price="2500" onchange="updateTotalPrice()">
                        <label for="lining_a_${itemId}">有料裏地A (¥2,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="lining_b_${itemId}" name="options_${itemId}" data-price="5000" onchange="updateTotalPrice()">
                        <label for="lining_b_${itemId}">有料裏地B (¥5,000)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="lining_c_${itemId}" name="options_${itemId}" data-price="17000" onchange="updateTotalPrice()">
                        <label for="lining_c_${itemId}">有料裏地C (¥17,000)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="hiromikaeshi_${itemId}" name="options_${itemId}" data-price="3500" onchange="updateTotalPrice()">
                        <label for="hiromikaeshi_${itemId}">広見返し (¥3,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="odaiba_${itemId}" name="options_${itemId}" data-price="2500" onchange="updateTotalPrice()">
                        <label for="odaiba_${itemId}">お台場 (¥2,500)</label>
                    </div>
                    
                    <div style="width: 100%; margin: 10px 0;">
                        <strong style="color: #2c3e50;">ボタンオプション</strong>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="button_a_${itemId}" name="options_${itemId}" data-price="1000" onchange="updateTotalPrice()">
                        <label for="button_a_${itemId}">有料ボタンA (¥1,000)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="button_b_${itemId}" name="options_${itemId}" data-price="2500" onchange="updateTotalPrice()">
                        <label for="button_b_${itemId}">有料ボタンB (¥2,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="button_c_${itemId}" name="options_${itemId}" data-price="3900" onchange="updateTotalPrice()">
                        <label for="button_c_${itemId}">有料ボタンC (¥3,900)</label>
                    </div>
                    
                    <div style="width: 100%; margin: 10px 0;">
                        <strong style="color: #2c3e50;">パンツオプション</strong>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="watch_pocket_${itemId}" name="options_${itemId}" data-price="1500" onchange="updateTotalPrice()">
                        <label for="watch_pocket_${itemId}">ウォッチポケット (¥1,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="full_lining_${itemId}" name="options_${itemId}" data-price="2500" onchange="updateTotalPrice()">
                        <label for="full_lining_${itemId}">総裏仕様 (¥2,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="side_adjuster_${itemId}" name="options_${itemId}" data-price="2500" onchange="updateTotalPrice()">
                        <label for="side_adjuster_${itemId}">サイド尾錠 (¥2,500)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="button_fly_${itemId}" name="options_${itemId}" data-price="1000" onchange="updateTotalPrice()">
                        <label for="button_fly_${itemId}">ボタン仕様 (¥1,000)</label>
                    </div>
                    
                    <div style="width: 100%; margin: 10px 0;">
                        <strong style="color: #2c3e50;">ベストオプション</strong>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="vest_collar_${itemId}" name="options_${itemId}" data-price="3000" onchange="updateTotalPrice()">
                        <label for="vest_collar_${itemId}">衿付き (¥3,000)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="vest_back_${itemId}" name="options_${itemId}" data-price="2000" onchange="updateTotalPrice()">
                        <label for="vest_back_${itemId}">背共生地 (¥2,000)</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="vest_double_${itemId}" name="options_${itemId}" data-price="3000" onchange="updateTotalPrice()">
                        <label for="vest_double_${itemId}">ダブル (¥3,000)</label>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="price_${itemId}">価格（円）</label>
                    <input type="number" id="price_${itemId}" name="price_${itemId}" step="1000" onchange="updateTotalPrice()">
                </div>
                <div class="form-group">
                    <label for="deliveryDate_${itemId}">納期</label>
                    <input type="date" id="deliveryDate_${itemId}" name="deliveryDate_${itemId}">
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes_${itemId}">備考</label>
                <textarea id="notes_${itemId}" name="notes_${itemId}" rows="2" placeholder="特別な要望や注意事項"></textarea>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHTML);
    itemCounter++;
    nextItemId++;
    
    setTimeout(() => {
        const newItem = container.querySelector(`[data-item="${itemId}"]`);
        if (newItem) {
            newItem.classList.remove('adding');
        }
    }, 300);
    
    updateItemCount();
    updateRemoveButtons();
}

function removeStyleItem(itemId) {
    const item = document.querySelector(`[data-item="${itemId}"]`);
    if (item && itemCounter > 1) {
        item.classList.add('removing');
        
        setTimeout(() => {
            item.remove();
            itemCounter--;
            updateItemCount();
            updateRemoveButtons();
            updateTotalPrice();
        }, 300);
    }
}

function updateItemCount() {
    const itemCountElement = document.getElementById('itemCount');
    if (itemCountElement) {
        itemCountElement.textContent = itemCounter;
    }
}

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('.remove-item-btn');
    removeButtons.forEach(button => {
        if (itemCounter <= 1) {
            button.style.display = 'none';
        } else {
            button.style.display = 'inline-block';
        }
    });
}

// =============================================================================
// 価格計算機能
// =============================================================================

function updateTotalPrice() {
    let total = 0;
    const breakdown = document.getElementById('priceBreakdown');
    if (breakdown) {
        breakdown.innerHTML = '';
    }

    const items = document.querySelectorAll('.style-item');
    items.forEach((item, index) => {
        const itemId = item.getAttribute('data-item');
        const priceInput = document.getElementById(`price_${itemId}`);
        const itemTypeSelect = document.getElementById(`itemType_${itemId}`);
        
        let itemTotal = 0;
        
        // 基本価格
        if (priceInput && priceInput.value) {
            itemTotal = parseInt(priceInput.value) || 0;
        }
        
        // オプション価格を加算
        const optionCheckboxes = item.querySelectorAll('input[type="checkbox"]:checked[data-price]');
        let optionTotal = 0;
        optionCheckboxes.forEach(checkbox => {
            optionTotal += parseInt(checkbox.getAttribute('data-price')) || 0;
        });
        
        itemTotal += optionTotal;
        total += itemTotal;
        
        // 明細に表示
        if (breakdown && itemTotal > 0) {
            const itemType = itemTypeSelect ? itemTypeSelect.value || `アイテム ${itemId}` : `アイテム ${itemId}`;
            const row = document.createElement('div');
            row.className = 'total-row';
            let displayText = itemType;
            if (optionTotal > 0) {
                displayText += ` (オプション: ¥${optionTotal.toLocaleString()})`;
            }
            row.innerHTML = `
                <span>${displayText}</span>
                <span>¥${itemTotal.toLocaleString()}</span>
            `;
            breakdown.appendChild(row);
        }
    });

    const grandTotalElement = document.getElementById('grandTotal');
    if (grandTotalElement) {
        grandTotalElement.textContent = `¥${total.toLocaleString()}`;
    }
    
    // ディスカウントを適用して最終価格を計算
    updateFinalPrice();
}

// ディスカウントの更新
function updateDiscount(type) {
    const grandTotalElement = document.getElementById('grandTotal');
    const totalText = grandTotalElement ? grandTotalElement.textContent : '¥0';
    const subtotal = parseInt(totalText.replace(/[¥,]/g, '')) || 0;
    
    const discountPercentInput = document.getElementById('discountPercent');
    const discountAmountInput = document.getElementById('discountAmount');
    
    if (type === 'percent') {
        // パーセント入力時
        const percent = parseFloat(discountPercentInput?.value) || 0;
        const discountAmount = Math.floor(subtotal * percent / 100);
        
        if (discountAmountInput) {
            discountAmountInput.value = discountAmount || '';
        }
    } else if (type === 'amount') {
        // 金額入力時
        const amount = parseInt(discountAmountInput?.value) || 0;
        const percent = subtotal > 0 ? (amount / subtotal * 100).toFixed(1) : 0;
        
        if (discountPercentInput) {
            discountPercentInput.value = percent || '';
        }
    }
    
    updateFinalPrice();
}

// 最終価格と残金を計算
function updateFinalPrice() {
    // 小計を取得
    const grandTotalElement = document.getElementById('grandTotal');
    const totalText = grandTotalElement ? grandTotalElement.textContent : '¥0';
    const subtotal = parseInt(totalText.replace(/[¥,]/g, '')) || 0;
    
    // 割引額を取得
    const discountAmountInput = document.getElementById('discountAmount');
    const discountAmount = parseInt(discountAmountInput?.value) || 0;
    
    // 最終価格を計算
    const finalTotal = subtotal - discountAmount;
    
    // 割引額表示を更新
    const discountDisplay = document.getElementById('discountDisplay');
    if (discountDisplay) {
        discountDisplay.textContent = discountAmount > 0 ? `-¥${discountAmount.toLocaleString()}` : '-¥0';
    }
    
    // 最終価格を表示
    const finalTotalElement = document.getElementById('finalTotal');
    if (finalTotalElement) {
        finalTotalElement.textContent = `¥${(finalTotal >= 0 ? finalTotal : 0).toLocaleString()}`;
    }
    
    // 残金も更新
    updateBalance();
}

// 残金を自動計算
function updateBalance() {
    // 最終価格を取得
    const finalTotalElement = document.getElementById('finalTotal');
    const finalText = finalTotalElement ? finalTotalElement.textContent : '¥0';
    const finalTotal = parseInt(finalText.replace(/[¥,]/g, '')) || 0;
    
    // 内金を取得
    const depositInput = document.getElementById('deposit');
    const deposit = parseInt(depositInput?.value) || 0;
    
    // 残金を計算
    const balance = finalTotal - deposit;
    
    // 残金フィールドに設定
    const balanceInput = document.getElementById('balance');
    if (balanceInput) {
        balanceInput.value = balance >= 0 ? balance : 0;
        
        // 残金がマイナスの場合は警告
        if (balance < 0) {
            showStatusMessage('⚠️ 内金が最終価格を超えています', 'info');
        }
    }
    
    // 総計セクションの表示も更新
    const depositDisplay = document.getElementById('depositDisplay');
    const balanceDisplay = document.getElementById('balanceDisplay');
    
    if (depositDisplay) {
        depositDisplay.textContent = `¥${deposit.toLocaleString()}`;
    }
    
    if (balanceDisplay) {
        balanceDisplay.textContent = `¥${(balance >= 0 ? balance : 0).toLocaleString()}`;
    }
}

// =============================================================================
// 印刷・PDF機能（モバイル対応版）
// =============================================================================

// 印刷プレビュー（改良版）
function printPreview() {
    // 印刷前に必須項目をチェック
    const fullName = document.getElementById('fullName')?.value.trim();
    
    if (!fullName) {
        showStatusMessage('❌ お客様のお名前を入力してください', 'error');
        return;
    }
    
    // 推奨ファイル名を生成
    const now = new Date();
    const dateStr = now.getFullYear() + 
                   String(now.getMonth() + 1).padStart(2, '0') + 
                   String(now.getDate()).padStart(2, '0');
    const suggestedFilename = `CRM顧客データ_${fullName}_${dateStr}.pdf`;
    
    // モーダルを表示
    showFilenameModal(suggestedFilename);
}

// モーダル表示
function showFilenameModal(filename) {
    const modal = document.getElementById('filenameModal');
    const filenameDisplay = document.getElementById('filenameDisplay');
    
    if (modal && filenameDisplay) {
        filenameDisplay.textContent = filename;
        modal.style.display = 'block';
        
        // コピーボタンの状態をリセット
        resetCopyButton();
    }
}

// モーダルを閉じる
function closeModal() {
    const modal = document.getElementById('filenameModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ファイル名を選択
function selectFilename() {
    const filenameDisplay = document.getElementById('filenameDisplay');
    if (filenameDisplay) {
        const range = document.createRange();
        range.selectNodeContents(filenameDisplay);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

// ファイル名をコピー
async function copyFilename() {
    const filenameDisplay = document.getElementById('filenameDisplay');
    const copyButton = document.getElementById('copyButton');
    const copyIcon = document.getElementById('copyIcon');
    const copyText = document.getElementById('copyText');
    
    if (!filenameDisplay) return;
    
    const filename = filenameDisplay.textContent;
    
    try {
        // モダンなClipboard APIを使用
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(filename);
        } else {
            // フォールバック：従来の方法
            const textArea = document.createElement('textarea');
            textArea.value = filename;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
        
        // 成功時の表示変更
        copyButton.classList.add('copied');
        copyIcon.textContent = '✅';
        copyText.textContent = 'コピーしました！';
        
        // 3秒後に元に戻す
        setTimeout(() => {
            resetCopyButton();
        }, 3000);
        
    } catch (error) {
        console.error('コピーエラー:', error);
        showStatusMessage('❌ コピーに失敗しました。手動で選択してコピーしてください。', 'error');
    }
}

// コピーボタンのリセット
function resetCopyButton() {
    const copyButton = document.getElementById('copyButton');
    const copyIcon = document.getElementById('copyIcon');
    const copyText = document.getElementById('copyText');
    
    if (copyButton) {
        copyButton.classList.remove('copied');
    }
    if (copyIcon) {
        copyIcon.textContent = '📋';
    }
    if (copyText) {
        copyText.textContent = 'ファイル名をコピー';
    }
}

// 印刷処理を続行
function proceedToPrint() {
    // モーダルを閉じる
    closeModal();
    
    // モバイルデバイスかどうかを判定
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    // アイテム数を確認
    const items = document.querySelectorAll('.style-item');
    const itemCount = items.length;
    
    // 印刷用の最適化
    preparePrintLayout(itemCount, isMobile);
    
    // 空の入力欄にプレースホルダーを設定
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"]');
    inputs.forEach(input => {
        if (!input.value && !input.placeholder) {
            input.setAttribute('data-print-placeholder', '―');
        }
    });
    
    // セレクトボックスで未選択の場合の処理
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        if (!select.value) {
            select.style.color = '#ccc';
        }
    });
    
    showStatusMessage('印刷プレビューを開いています...', 'info');
    
    // 印刷ダイアログを開く
    setTimeout(() => {
        window.print();
        
        // 印刷後にスタイルを元に戻す
        selects.forEach(select => {
            select.style.color = '';
        });
        
        inputs.forEach(input => {
            input.removeAttribute('data-print-placeholder');
        });
        
        // 印刷レイアウトのクリーンアップ
        cleanupPrintLayout();
    }, 500);
}

// モーダルの外側をクリックで閉じる
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('filenameModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });
    }
});

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

// 印刷レイアウトの準備
function preparePrintLayout(itemCount, isMobile) {
    // 印刷用のスタイルを動的に追加
    const printStyle = document.createElement('style');
    printStyle.id = 'dynamicPrintStyle';
    
    let styleContent = `
        @media print {
            /* 空の入力欄にプレースホルダーを表示 */
            input[data-print-placeholder]::after {
                content: attr(data-print-placeholder);
                color: #999;
            }
            
            /* ページ余白の最適化 */
            @page {
                margin: ${isMobile ? '5mm' : '10mm'};
            }
    `;
    
    // アイテム数に応じたページ分割戦略
    if (itemCount <= 2) {
        // 1-2アイテム: すべてを最大2ページに収める
        styleContent += `
            /* 1-2アイテム用の超コンパクトレイアウト */
            .section {
                margin-bottom: 3px !important;
            }
            
            .form-group {
                margin-bottom: 2px !important;
            }
            
            .style-item {
                margin-bottom: 3px !important;
                padding: 3px !important;
            }
            
            /* 任意情報セクションを横並びに */
            .section:nth-of-type(2) .form-row {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 3px !important;
            }
            
            /* 支払い・納期・備考を1ページ目の下部に配置 */
            #payment-section,
            .section:last-of-type {
                page-break-inside: avoid !important;
            }
        `;
    } else if (itemCount >= 3) {
        // 3個以上: スタイルセクションを2ページ目に
        styleContent += `
            /* 3個以上のアイテム用のページ分割 */
            .section:nth-of-type(4) { /* スタイル・仕様セクション */
                page-break-before: always !important;
                margin-top: 0 !important;
            }
            
            /* アイテムごとのページ分割 */
            .style-item:nth-child(n+3) {
                page-break-before: auto !important;
            }
            
            /* 5個以上の場合は2個ずつページ分割 */
            ${itemCount >= 5 ? `
                .style-item:nth-child(3),
                .style-item:nth-child(5),
                .style-item:nth-child(7) {
                    page-break-before: always !important;
                }
            ` : ''}
        `;
    }
    
    // モバイル用の追加最適化
    if (isMobile) {
        styleContent += `
            /* モバイル印刷の最適化 */
            body {
                font-size: 7pt !important;
            }
            
            .section-title {
                font-size: 8pt !important;
                padding: 2px 5px !important;
            }
            
            .form-group label {
                font-size: 6pt !important;
            }
            
            .measurement-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            
            .checkbox-group {
                grid-template-columns: repeat(2, 1fr) !important;
                font-size: 5pt !important;
            }
            
            /* 備考欄のサイズ調整 */
            .notes-area {
                height: 40px !important;
                font-size: 6pt !important;
            }
        `;
    }
    
    styleContent += `
        } /* @media print の終了 */
    `;
    
    printStyle.innerHTML = styleContent;
    document.head.appendChild(printStyle);
    
    // bodyに印刷モードクラスを追加
    document.body.classList.add('print-mode');
    
    // スタイル・仕様セクションにアイテム数クラスを追加
    const styleSection = document.querySelector('.section:has(#styleItemsContainer)');
    if (styleSection && itemCount >= 3) {
        styleSection.classList.add('style-section-3plus');
    }
}

// 印刷レイアウトのクリーンアップ
function cleanupPrintLayout() {
    // 追加したスタイルを削除
    const printStyle = document.getElementById('dynamicPrintStyle');
    if (printStyle) {
        printStyle.remove();
    }
    
    // 印刷モードクラスを削除
    document.body.classList.remove('print-mode');
    
    // スタイルセクションのクラスを削除
    const styleSection = document.querySelector('.style-section-3plus');
    if (styleSection) {
        styleSection.classList.remove('style-section-3plus');
    }
}

// =============================================================================
// イベントリスナーとエラーハンドリング
// =============================================================================

window.addEventListener('online', function() {
    showStatusMessage('🌐 ネットワーク接続が復旧しました', 'success');
});

window.addEventListener('offline', function() {
    showStatusMessage('📱 オフラインモードです。ローカル保存をご利用ください', 'info');
});

window.addEventListener('beforeunload', function(e) {
    const fullName = document.getElementById('fullName')?.value;
    
    if (fullName) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// =============================================================================
// デバッグとログ出力
// =============================================================================

console.log('=== CRMオーダーシステム 改善版 ===');
console.log('初期化完了時刻:', new Date().toISOString());
console.log('改善内容:');
console.log('- 姓名統合');
console.log('- 裏地オプション追加');
console.log('- 新規フィールド追加');
console.log('- UI簡素化');
console.log('========================');
    </script>
</body>
</html>
